cscope 15 /afs/cs.wisc.edu/p/paradyn/development/wenbin/spi/spi/src/Agent               0000077888
	@SpAddrSpace.C

1 
	~"SpAddrS·û.h
"

2 
	~"SpObjeù.h
"

4 
usšg
 
	gdt
::
Add»ss
;

5 
usšg
 
	g¥
::
SpAddrS·û
;

6 
usšg
 
	gph
::
P©chObjeù
;

8 
Çme¥aû
 
	g¥
 {

12 
	gSpAddrS·û
::
SpAddrS·û
(è: 
ph
::
AddrS·û
() {

13 
upd©e_mem_m­s
();

18 
SpAddrS·û
*

19 
	gSpAddrS·û
::
ü—‹
(
P©chObjeù
* 
obj
) {

20 
as£¹
(
obj
);

21 
SpAddrS·û
* 
	g»t
 = 
Ãw
 SpAddrSpace;

22 ià(!
	g»t
) „et;

23 
	g»t
->
š™
(
obj
);

24  
	g»t
;

28 
Add»ss


29 
	gSpAddrS·û
::
m®loc
(
P©chObjeù
* 
obj
, 
size_t
 
size
, 
Add»ss
 
Ã¬
) {

30 
Add»ss
 
	gbuf
 = 0;

31 
	gbuf
 = (
Add»ss
)::
m®loc
(
size
+ 
g‘·gesize
() -1);

32 ià(!
	gbuf
)  0;

33 
	gbuf
 = (((
Add»ss
)
buf
 + 
g‘·gesize
()-1) & ~(getpagesize()-1));

34  
	gbuf
;

37 
Add»ss
 
	gps
 = 
g‘·gesize
();

38 
Add»ss
 
	gr_Ã¬
 = ((
Ã¬
 + 
ps
 -1) & ~(ps - 1));

39 
Add»ss
 
	gr_size
 = ((
size
 + 
ps
 -1) & ~(ps - 1));

40 
	gbuf
 = 
r_Ã¬
;

42 
¥_´št
("page size: %d,‚ear: %lx,„_near: %lx, size: %d,„_size: %d",

43 
ps
, 
Ã¬
, 
r_Ã¬
, 
size
, 
r_size
);

44 * 
	gm
 = 
NULL
;

45 
	gfd
 = -1;

46 !
	gm
 | ()m == -1) {

47 
buf
 -ğ
r_size
;

48 
¥_´št
("lookšg fÜ %lx", 
buf
);

49 
	gm
 = 
mm­
((*)
buf
,

50 
r_size
,

51 
PROT_WRITE
 | 
PROT_READ
,

52 
MAP_PRIVATE
 | 
MAP_FIXED
 | 
MAP_ANONYMOUS
,

53 
fd
,

56 ià(!
	gm
)  0;

57 
¥_´št
("g‘ buf: %lx", 
m
);

58  (
	gAdd»ss
)
	gm
;

62 
boŞ


63 
	gSpAddrS·û
::
wr™e
(
P©chObjeù
* 
obj
, 
Add»ss
 
to
, Add»s 
äom
, 
size_t
 
size
) {

64  (
memıy
((*)
to
, (*)
äom
, 
size
) == (*)to);

68 
boŞ


69 
	gSpAddrS·û
::
ä“
(
P©chObjeù
* 
obj
, 
Add»ss
 
Üig
) {

73 ::
ä“
((*)
Üig
);

74  
	gŒue
;

78 
boŞ


79 
	gSpAddrS·û
::
£t_¿nge_³rm
(
Add»ss
 
a
, 
size_t
 
Ëngth
, 
³rm
) {

80 
boŞ
 
	g»t
 = 
çl£
;

87 
	gMemM­pšgs
::
™”©Ü
 
mi
 = 
mem_m­s_
.
begš
();

88 
	gmi
 !ğ
mem_m­s_
.
’d
(); mi++) {

89 
Add»ss
 
	g¡¬t
 = 
mi
->
fœ¡
;

90 
	gMemM­pšg
& 
	gmm
 = 
mi
->
£cÚd
;

91 
Add»ss
 
	g’d
 = 
mm
.
’d
;

92 
Add»ss
 
	gcode_’d
 = 
a
 + 
Ëngth
;

93 ià((
	ga
 >ğ
¡¬t
 && 
code_’d
 < 
’d
) ||

94 (
a
 <ğ
¡¬t
 && 
code_’d
 >ğ¡¬ˆ&& code_’d <ğ
’d
) ||

95 (
a
 >ğ
¡¬t
 &&‡ < 
’d
 && 
code_’d
 >=ƒnd)) {

97 ià(
m´Ùeù
((*)
¡¬t
, 
’d
 - s¹, 
³rm
) < 0) {

98 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

99 
³¼Ü
("mprotect");

100  
	gçl£
;

102 
	g»t
 = 
Œue
;

108 ià(!
	g»t
) {

109 
Add»ss
 
	g®igÃd
 = 
a
;

110 
size_t
 
	gpz
 = 
g‘·gesize
();

111 
	g®igÃd
 = (
Add»ss
)(((Add»ssè
®igÃd
 + 
pz
-1) & ~(pz-1));

112 ià(
m´Ùeù
((*)
®igÃd
, 
Ëngth
, 
³rm
) < 0) {

113 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

114 
³¼Ü
("mprotect");

115  
	gçl£
;

117 
	g»t
 = 
Œue
;

121  
	g»t
;

124 
boŞ


125 
	gSpAddrS·û
::
»¡Üe_¿nge_³rm
(
Add»ss
 
a
, 
size_t
 
Ëngth
) {

126 
boŞ
 
	g»t
 = 
çl£
;

127 
	gMemM­pšgs
::
™”©Ü
 
mi
 = 
mem_m­s_
.
begš
();

128 
	gmi
 !ğ
mem_m­s_
.
’d
(); mi++) {

129 
Add»ss
 
	g¡¬t
 = 
mi
->
fœ¡
;

130 
	gMemM­pšg
& 
	gmm
 = 
mi
->
£cÚd
;

131 
Add»ss
 
	g’d
 = 
mm
.
’d
;

132 
Add»ss
 
	gcode_’d
 = 
a
 + 
Ëngth
;

133 ià((
	ga
 >ğ
¡¬t
 && 
code_’d
 < 
’d
) ||

134 (
a
 <ğ
¡¬t
 && 
code_’d
 >ğ¡¬ˆ&& code_’d <ğ
’d
) ||

135 (
a
 >ğ
¡¬t
 &&‡ < 
’d
 && 
code_’d
 >=ƒnd)) {

137 ià(
m´Ùeù
((*)
¡¬t
, 
’d
 - s¹, 
mem_m­s_
[¡¬t].
³rms
) < 0) {

138 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

139  
	gçl£
;

141 
	g»t
 = 
Œue
;

145  
	g»t
;

150 
	gSpAddrS·û
::
upd©e_mem_m­s
() {

152 
m­s_fe
[256];

153 
¥rštf
(
m­s_fe
, "/´oc/%d/m­s", 
g‘pid
());

155 
FILE
* 
	gå
 = 
fİ’
(
m­s_fe
, "r");

156 ià(!
	gå
) {

157 
¥_³¼Ü
("FAILEDØİ’ memÜy m­pšg f%s", 
m­s_fe
);

159 
	glšebuf
[2048];

160 
fg‘s
(
lšebuf
, 2048, 
å
è!ğ
NULL
) {

161 * 
¡¬t_addr_s
 = 
lšebuf
;

162 * 
	g’d_addr_s
 = 
¡rchr
(
lšebuf
, '-');

163 *
	g’d_addr_s
 = '\0';

164 
	g’d_addr_s
++;

166 * 
	g³rms_s
 = 
¡rchr
(
’d_addr_s
, ' ');

167 *
	g³rms_s
 = '\0';

168 
	g³rms_s
++;

170 * 
	goff£t_s
 = 
¡rchr
(
³rms_s
, ' ');

171 *
	goff£t_s
 = '\0';

172 
	goff£t_s
++;

174 * 
	gdev_s
 = 
¡rchr
(
off£t_s
, ' ');

175 *
	gdev_s
 = '\0';

176 
	gdev_s
++;

178 * 
	gšode_s
 = 
¡rchr
(
dev_s
, ' ');

179 *
	gšode_s
 = '\0';

180 
	gšode_s
++;

182 * 
	gpch
 = 
¡¹ok
(
šode_s
, " \n\r");

183 
	gšode_s
 = 
pch
;

184 * 
	g·th_s
 = 
NULL
;

185 ià(
	gpch
 !ğ
NULL
) {

186 
pch
 = 
¡¹ok
(
NULL
, " \n\r");

187 ià(
	gpch
) {

188 
	g·th_s
 = 
pch
;

192 * 
	gpDummy
;

193 
Add»ss
 
	g¡¬t
 = 
¡¹Şl
(
¡¬t_addr_s
, &
pDummy
, 16);

196 ià(
	gmem_m­s_
.
fšd
(
¡¬t
è=ğ
mem_m­s_
.
’d
()) {

197 
MemM­pšg
& 
m­pšg
 = 
mem_m­s_
[
¡¬t
];

198 
	gm­pšg
.
	g¡¬t
 = 
¡¬t
;

199 
	gm­pšg
.
	g’d
 = 
¡¹Ş
(
’d_addr_s
, &
pDummy
, 16);

200 
	gm­pšg
.
	goff£t
 = 
¡¹Ş
(
off£t_s
, &
pDummy
, 16);

201 
	gm­pšg
.
	gdev
 = 
dev_s
;

202 
	gm­pšg
.
	gšode
 = 
¡¹Ş
(
šode_s
, &
pDummy
, 16);

203 ià(
	g·th_s
è
	gm­pšg
.
	g·th
 = 
·th_s
;

204 
	g³rms
 = 0;

205 
	gcouÁ
 = 0;

206 ià(
	g³rms_s
[0] == 'r') {

207 
³rms
 |ğ
PROT_READ
;

208 ++
	gcouÁ
;

210 ià(
	g³rms_s
[1] == 'w') {

211 
³rms
 |ğ
PROT_WRITE
;

212 ++
	gcouÁ
;

214 ià(
	g³rms_s
[2] == 'x') {

215 
³rms
 |ğ
PROT_EXEC
;

216 ++
	gcouÁ
;

218 ià(
	gcouÁ
 =ğ3è
³rms
 = 
PROT_NONE
;

219 
	gm­pšg
.
	g³rms
 = 
³rms
;

222 
fşo£
(
å
);

226 
	gSpAddrS·û
::
dump_mem_m­s
() {

227 #iâdeà
SP_RELEASE


228 
¥_debug
("MMAPS - %d memÜy m­pšgs", 
mem_m­s_
.
size
());

230 
	gMemM­pšgs
::
™”©Ü
 
mi
 = 
mem_m­s_
.
begš
(); 
	gmi
 !ğmem_m­s_.
’d
(); mi++) {

231 
	gMemM­pšg
& 
	gm­pšg
 = 
mi
->
£cÚd
;

232 #iâdeà
SP_RELEASE


233 
¥_debug
("MMAP - Range[%lx ~ %lx], Offset %lx, Perm %x, Dev %s, Inode %d, Path %s",

234 
m­pšg
.
¡¬t
, m­pšg.
’d
, m­pšg.
off£t
, m­pšg.
³rms
,

235 
m­pšg
.
dev
.
c_¡r
(), m­pšg.
šode
, m­pšg.
·th
.c_str());

240 
	gSpAddrS·û
::
lßdLib¿ry
(
ph
::
P©chObjeù
* 
obj
) {

241 
lßdObjeù
(
obj
);

242 
´e_®loc_Ã¬
(
¡©ic_ÿ¡
<
SpObjeù
*>(
obj
));

251 
	gSpAddrS·û
::
´e_®loc_Ã¬
(
¥
::
SpObjeù
* 
obj
) {

254 
	gbuf_size_
 = 1024;

255 
	gmax_buf_num_
 = 10;

256 
size_t
 
	gmax_size
 = 
max_buf_num_
 * 
buf_size_
;

258 
Add»ss
 
	gps
 = 
g‘·gesize
();

259 
Add»ss
 
	gr_Ã¬
 = ((
obj
->
lßd_addr
(è+ 
ps
 -1) & ~(ps - 1));

260 
Add»ss
 
	gr_size
 = ((
max_size
 + 
ps
 -1) & ~(ps - 1));

261 
Add»ss
 
	gbuf
 = 
r_Ã¬
;

263 
upd©e_mem_m­s
();

264 
dump_mem_m­s
();

265 
¥_´št
("codeBa£: %lx,„_Ã¬: %lx,„_size: %d", 
obj
->
codeBa£
(), 
r_Ã¬
, 
r_size
);

267 * 
	gm
 = 
NULL
;

268 
	gfd
 = -1;

269 !
	gm
 | ()m == -1) {

270 
buf
 -ğ
r_size
;

272 
	gm
 = 
mm­
((*)
buf
,

273 
r_size
,

274 
PROT_WRITE
 | 
PROT_READ
,

275 
MAP_PRIVATE
 | 
MAP_FIXED
 | 
MAP_ANONYMOUS
,

276 
fd
,

280 ià(!
	gm
) {

284 
¥_´št
("g‘ buf: %lx", 
m
);

290 
	gSpAddrS·û
::
g‘_Ã¬
(
ph
::
Pošt
* 
±
) {

	@SpAgent.C

1 
	~"SpAg’t.h
"

2 
	~"SpCÚ‹xt.h
"

4 
usšg
 
	g¥
::
SpAg’t
;

5 
usšg
 
	g¥
::
SpP¬£r
;

6 
usšg
 
	g¥
::
SpCÚ‹xt
;

8 
usšg
 
	gph
::
P©chMgr
;

9 
usšg
 
	gph
::
AddrS·û
;

10 
usšg
 
	gph
::
P©chObjeù
;

12 
usšg
 
	g³
::
CodeObjeù
;

15 
	gSpAg’t
::
±r


16 
SpAg’t
::
	$ü—‹
() {

19 ià(
	`g‘’v
("SP_COREDUMP")) {

20 
¾im™
 
cÜe_lim™
;

21 
cÜe_lim™
.
¾im_cur
 = 
RLIM_INFINITY
;

22 
cÜe_lim™
.
¾im_max
 = 
RLIM_INFINITY
;

23 ià(
	`£Œlim™
(
RLIMIT_CORE
, &
cÜe_lim™
) < 0) {

24 
	`¥_³¼Ü
("ERROR: failedo setup core dump‡bility\n");

27  
	`±r
(
Ãw
 
	`SpAg’t
());

28 
	}
}

30 
	gSpAg’t
::
	$SpAg’t
() {

32 
š™_ev’t_
 = 
SpEv’t
::
	`±r
();

33 
fši_ev’t_
 = 
SpEv’t
::
	`±r
();

34 
·r£r_
 = 
SpP¬£r
::
	`±r
();

36 
·r£_Úly_
 = 
çl£
;

37 
dœeùÿÎ_Úly_
 = 
çl£
;

38 
®low_c_
 = 
çl£
;

39 
	}
}

41 
	gSpAg’t
::~
	$SpAg’t
() {

44 
	}
}

48 
SpAg’t
::
£t_·r£r
(
SpP¬£r
::
±r
 
·r£r
) {

49 
·r£r_
 = 
·r£r
;

53 
	gSpAg’t
::
£t_š™_ev’t
(
SpEv’t
::
±r
 
e
) {

54 
š™_ev’t_
 = 
e
;

58 
	gSpAg’t
::
£t_fši_ev’t
(
SpEv’t
::
±r
 
e
) {

59 
š™_ev’t_
 = 
e
;

63 
	gSpAg’t
::
	$£t_š™_befÜe
(
¡ršg
 
p
) {

64 
š™_befÜe_
 = 
p
;

65 
	}
}

68 
	gSpAg’t
::
	$£t_š™_aá”
(
¡ršg
 
p
) {

69 
š™_aá”_
 = 
p
;

70 
	}
}

73 
	gSpAg’t
::
£t_š™_´İ–Ër
(
SpPrİ–Ër
::
±r
 
p
) {

74 
š™_´İ–Ër_
 = 
p
;

78 
	gSpAg’t
::
	$£t_·r£_Úly
(
boŞ
 
b
) {

79 
·r£_Úly_
 = 
b
;

80 
	}
}

83 
	gSpAg’t
::
	$£t_dœeùÿÎ_Úly
(
boŞ
 
b
) {

84 
dœeùÿÎ_Úly_
 = 
b
;

85 
	}
}

88 
	gSpAg’t
::
	$£t_c
(
boŞ
 
b
) {

89 
®low_c_
 = 
b
;

90 
	}
}

94 
	gSpAg’t
::
	$go
() {

96 #iâdeà
SP_RELEASE


97 
	`¥_debug
("=========ğS¹ S–f-´İ–Ëd in¡rum’tiÚ @ Proûs %d ==========", 
	`g‘pid
());

101 ià(!
š™_ev’t_
) {

102 #iâdeà
SP_RELEASE


103 
	`¥_debug
("INIT EVENT - Use defaultƒvent");

105 
š™_ev’t_
 = 
SyncEv’t
::
	`ü—‹
();

107 ià(!
fši_ev’t_
) {

108 #iâdeà
SP_RELEASE


109 
	`¥_debug
("FINI EVENT - Use defaultƒvent");

111 
fši_ev’t_
 = 
SpEv’t
::
	`ü—‹
();

113 ià(
š™_befÜe_
.
	`size
() == 0) {

114 #iâdeà
SP_RELEASE


115 
	`¥_debug
("BEFORE_PAYLOAD - Use default…ayload before calls");

117 
š™_befÜe_
 = "default_before";

119 ià(
š™_aá”_
.
	`size
() == 0) {

120 #iâdeà
SP_RELEASE


121 
	`¥_debug
("AFTER_PAYLOAD - No…ayload‡fter calls");

123 
š™_aá”_
 = "";

125 ià(!
·r£r_
) {

126 #iâdeà
SP_RELEASE


127 
	`¥_debug
("PARSER - Use default…arser");

129 
·r£r_
 = 
SpP¬£r
::
	`ü—‹
();

131 ià(!
š™_´İ–Ër_
) {

132 #iâdeà
SP_RELEASE


133 
	`¥_debug
("PROPELLER - Use default…ropeller");

136 
š™_´İ–Ër_
 = 
SpPrİ–Ër
::
	`ü—‹
();

138 #iâdeà
SP_RELEASE


139 ià(
dœeùÿÎ_Úly_
) {

140 
	`¥_debug
("DIRECT CALL ONLY - only instrument direct calls, ignoring indirect calls");

142 
	`¥_debug
("DIRECT/INDIRECT CALL - instrument both direct‡nd indirect calls");

144 ià(
®low_c_
) {

145 
	`¥_debug
("MULTI PROCESS - support multiprocess instrumentation");

147 
	`¥_debug
("SINGLE PROCESS - only support single-process instrumentation");

152 
cÚ‹xt_
 = 
SpCÚ‹xt
::
	`ü—‹
(
š™_´İ–Ër_
,

153 
š™_befÜe_
,

154 
š™_aá”_
,

155 
·r£r_
);

156 
cÚ‹xt_
->
	`£t_dœeùÿÎ_Úly
(
dœeùÿÎ_Úly_
);

157 
cÚ‹xt_
->
	`£t_®low_c
(
®low_c_
);

159 ià(
·r£_Úly_
) {

160 #iâdeà
SP_RELEASE


161 
	`¥_debug
("PARSE ONLY -ƒxit‡fter…arsing, without instrumentation");

168 
š™_ev’t_
->
	`»gi¡”_ev’t
(
cÚ‹xt_
);

169 
fši_ev’t_
->
	`»gi¡”_ev’t
(
cÚ‹xt_
);

170 
	}
}

	@SpArch-i386.C

1 
	~"SpEv’t.h
"

2 
	~"SpP¬£r.h
"

3 
	~"SpCÚ‹xt.h
"

4 
	~"SpSn³t.h
"

5 
	~"SpUts.h
"

6 
	~"SpPošt.h
"

8 
usšg
 
	gdt
::
Add»ss
;

10 
usšg
 
	gš
::
ResuÉ
;

11 
usšg
 
	gš
::
Vis™Ü
;

12 
usšg
 
	gš
::
ImmedŸ‹
;

13 
usšg
 
	gš
::
c_C®lIn¢
;

14 
usšg
 
	gš
::
Ex´essiÚ
;

15 
usšg
 
	gš
::
In¡ruùiÚ
;

16 
usšg
 
	gš
::
D”eã»nû
;

17 
usšg
 
	gš
::
Regi¡”AST
;

18 
usšg
 
	gš
::
Bš¬yFunùiÚ
;

20 
Çme¥aû
 
	g¥
 {

27 
size_t


28 
	gSpSn³t
::
em™_§ve
(* 
buf
, 
size_t
 
off£t
, 
boŞ
) {

29 * 
	gp
 = 
buf
 + 
off£t
;

32 *
	gp
++ = 0x60;

34 
size_t
 
	gš¢size
 = 
em™_§ve_¥
(
p
, 0);

35 
	gp
 +ğ
š¢size
;

37  (
	gp
 - (
	gbuf
 + 
	goff£t
));

41 
size_t


42 
	gSpSn³t
::
em™_»¡Üe
Ğ* 
buf
, 
size_t
 
off£t
, 
boŞ
) {

43 * 
	gp
 = 
buf
 + 
off£t
;

45 *
	gp
++ = 0x61;

46  (
	gp
 - (
	gbuf
 + 
	goff£t
));

50 
size_t


51 
	gSpSn³t
::
em™_çuÉ
(* 
buf
, 
size_t
 
off£t
) {

52 * 
	gp
 = 
buf
 + 
off£t
;

55 *
	gp
++ = ()0xc7;

56 *
	gp
++ = ()0x05;

58 *
	gp
++ = ()0x00;

59 *
	gp
++ = ()0x00;

60 *
	gp
++ = ()0x00;

61 *
	gp
++ = ()0x00;

63 *
	gp
++ = ()0x00;

64 *
	gp
++ = ()0x00;

65 *
	gp
++ = ()0x00;

66 *
	gp
++ = ()0x00;

68  (
	gp
 - (
	gbuf
 + 
	goff£t
));

75 
size_t


76 
	gSpSn³t
::
em™_§ve_¥
(* 
buf
, 
size_t
 
off£t
) {

77 * 
	gp
 = 
buf
 + 
off£t
;

79 *
	gp
++ = 0x89;

80 *
	gp
++ = 0x25;

82 * 
	gl
 = (*)
p
;

83 *
	gl
 = ()&
§ved_cÚ‹xt_loc_
;

84 
	gp
 += ();

86  (
	gp
 - (
	gbuf
 + 
	goff£t
));

90 
size_t


91 
em™_push_imm32
(
imm
, * 
buf
, 
size_t
 
off£t
) {

92 * 
	gp
 = 
buf
 + 
off£t
;

95 *
	gp
++ = 0x68;

96 * 
	gi
 = (*)
p
;

97 *
	gi
 = 
imm
;

98 
	gp
 += ();

100  (
	gp
 - (
	gbuf
 + 
	goff£t
));

104 
size_t


105 
em™_pİ_imm32
(* 
buf
, 
size_t
 
off£t
) {

106 * 
	gp
 = 
buf
 + 
off£t
;

108 *
	gp
++ = 0x58;

109  (
	gp
 - (
	gbuf
 + 
	goff£t
));

116 
size_t


117 
	gSpSn³t
::
em™_·ss_·¿m
(
pošt
, 
·ylßd
, * 
buf
, 
size_t
 
off£t
) {

118 * 
	gp
 = 
buf
 + 
off£t
;

119 
size_t
 
	gš¢size
 = 0;

121 ià(
	g·ylßd
) {

123 
	gš¢size
 = 
em™_push_imm32
(()
·ylßd
, 
p
, 0);

124 
	gp
 +ğ
š¢size
;

128 
	gš¢size
 = 
em™_push_imm32
(()
pošt
, 
p
, 0);

129 
	gp
 +ğ
š¢size
;

131  (
	gp
 - (
	gbuf
 + 
	goff£t
));

138 
size_t


139 
	gSpSn³t
::
em™_ÿÎ_abs
(
ÿÎ“
, * 
buf
, 
size_t
 
off£t
, 
boŞ
 
»¡Üe
) {

140 * 
	gp
 = 
buf
 + 
off£t
;

141 
Add»ss
 
	g»ddr
 = (Add»ss)
p
+5;

142 
size_t
 
	gš¢size
 = 0;

143 
Add»ss
 
	g»l_addr
 = (
ÿÎ“
 - 
»ddr
);

145 ià(
	g¥
::
is_di¥32
(
»l_addr
)) {

147 *
p
++ = 0xe8;

148 * 
	g»l_p
 = (*)
p
;

149 *
	g»l_p
 = 
»l_addr
;

150 
	gp
 += ();

152 
¥_³¼Ü
("largerhan 4 bytes for call‡ddress");

155 ià(
	g»¡Üe
) {

157 
	gš¢size
 = 
em™_pİ_imm32
(
p
, 0);

158 
	gp
 +ğ
š¢size
;

160 ià(
	gcÚ‹xt_
->
®low_c
()) {

162 
	gš¢size
 = 
em™_pİ_imm32
(
p
, 0);

163 
	gp
 +ğ
š¢size
;

167  (
	gp
 - (
	gbuf
 + 
	goff£t
));

175 
size_t


176 
	gSpSn³t
::
em™_jump_abs
(
Œg
, * 
buf
, 
size_t
 
off£t
, 
boŞ
 
abs
) {

177 * 
	gp
 = 
buf
 + 
off£t
;

178 
size_t
 
	gš¢size
 = 0;

180 
Add»ss
 
	g»ddr
 = (Add»ss)
p
+5;

181 
Add»ss
 
	g»l_addr
 = (
Œg
 - 
»ddr
);

183 ià(
	g¥
::
is_di¥32
(
»l_addr
è&& !
abs
) {

185 *
p
++ = 0xe9;

186 * 
	g»l_p
 = (*)
p
;

187 *
	g»l_p
 = 
»l_addr
;

188 
	gp
 += 4;

191 
	gš¢size
 = 
em™_push_imm32
(
Œg
, 
p
, 0);

192 
	gp
 +ğ
š¢size
;

194 *
	gp
++ = 0xc3;

197  (
	gp
 - (
	gbuf
 + 
	goff£t
));

203 
size_t


204 
	gSpSn³t
::
em™_ÿÎ_Üig
(
¤c
, 
size_t
 
size
, * 
buf
, size_ˆ
off£t
) {

205 * 
	gp
 = 
buf
 + 
off£t
;

206 * 
	gp¤c
 = (*)
¤c
;

207 
memıy
(
p
, 
p¤c
, 
size
);

208  
	gsize
;

212 
size_t


213 
	gSpSn³t
::
»loc_š¢
(
Add»ss
 
¤c_š¢
, 
In¡ruùiÚ
::
PŒ
 
š¢
,

214 
Add»ss
 
Ï¡
, * 
buf
) {

218 
Add»ss
 
	ga
 = 
¤c_š¢
;

219 ià(
	ga
 =ğ
Ï¡
)  0;

222 * 
	gp
 = 
buf
;

223 ià(
	gš¢
->
g‘C©egÜy
(è=ğ
c_C®lIn¢
 &&

224 
a
 !ğ
Ï¡
) {

229 *
p
++ = 0xbb;

230 * 
	gÃw_ebx
 = (*)
p
;

231 *
	gÃw_ebx
 = ()(
a
+5);

235 
memıy
(
p
, 
š¢
->
±r
(), in¢->
size
());

236  
	gš¢
->
size
();

245 
Add»ss


246 
	gSpSn³t
::
g‘_´e_sigÇl_pc
(* 
cÚ‹xt
) {

247 
ucÚ‹xt_t
* 
ùx
 = (ucÚ‹xt_t*)
cÚ‹xt
;

248  
	gùx
->
	guc_mcÚ‹xt
.
	gg»gs
[
REG_EIP
];

252 
Add»ss


253 
	gSpSn³t
::
£t_pc
(
Add»ss
 
pc
, * 
cÚ‹xt
) {

254 
ucÚ‹xt_t
* 
	gùx
 = (ucÚ‹xt_t*)
cÚ‹xt
;

255 
	gùx
->
	guc_mcÚ‹xt
.
	gg»gs
[
REG_EIP
] = 
pc
;

259 
Add»ss


260 
	gSpSn³t
::
g‘_§ved_»g
(
Dynš¡
::
MachRegi¡”
 
»g
) {

264 
	#EDI
 0

	)

265 
	#ESI
 4

	)

266 
	#EBP
 8

	)

267 
	#ESP
 12

	)

268 
	#EBX
 16

	)

269 
	#EDX
 20

	)

270 
	#ECX
 24

	)

271 
	#EAX
 28

	)

273 
	#»g_v®
(
i
è(*(*)(
§ved_cÚ‹xt_loc_
+(i)))

	)

279 
usšg
 
Çme¥aû
 
Dynš¡
::
x86
;

280 ià(
	g»g
 =ğ
edi
è 
»g_v®
(
EDI
);

281 ià(
	g»g
 =ğ
esi
è 
»g_v®
(
ESI
);

282 ià(
	g»g
 =ğ
ebp
è 
»g_v®
(
EBP
);

283 ià(
	g»g
 =ğ
e¥
è 
»g_v®
(
ESP
);

284 ià(
	g»g
 =ğ
ebx
è 
»g_v®
(
EBX
);

285 ià(
	g»g
 =ğ
edx
è 
»g_v®
(
EDX
);

286 ià(
	g»g
 =ğ
ecx
è 
»g_v®
(
ECX
);

287 ià(
	g»g
 =ğ
—x
è 
»g_v®
(
EAX
);

293 
boŞ


294 
	gSpP¬£r
::
is_pc
(
Dynš¡
::
MachRegi¡”
 
r
) {

295 ià(
r
 =ğ
Dynš¡
::
x86
::
e
è 
Œue
;

296  
	gçl£
;

301 
size_t


302 
	gSpSn³t
::
jump_abs_size
() {

311 
	gSpSn³t
::
pİ_¬gum’t
(
Argum’tHªdË
* 
h
, 
size_t
 
size
) {

312 * 
	ga
 = (*)(
§ved_cÚ‹xt_loc_
 + 32 + 
h
->
off£t
);

313 
	gh
->
	goff£t
 +ğ
size
;

314  
	ga
;

319 
	gSpSn³t
::
g‘_»t_v®
() {

320  
g‘_§ved_»g
(
Dynš¡
::
x86
::
—x
);

	@SpArch-x86_64.C

1 
	~"SpEv’t.h
"

2 
	~"SpP¬£r.h
"

3 
	~"SpCÚ‹xt.h
"

4 
	~"SpSn³t.h
"

5 
	~"SpPošt.h
"

6 
	~"SpUts.h
"

8 
usšg
 
	gdt
::
Add»ss
;

10 
usšg
 
	gph
::
P©chFunùiÚ
;

12 
usšg
 
	gš
::
ResuÉ
;

13 
usšg
 
	gš
::
Vis™Ü
;

14 
usšg
 
	gš
::
ImmedŸ‹
;

15 
usšg
 
	gš
::
Ex´essiÚ
;

16 
usšg
 
	gš
::
In¡ruùiÚ
;

17 
usšg
 
	gš
::
D”eã»nû
;

18 
usšg
 
	gš
::
Regi¡”AST
;

19 
usšg
 
	gš
::
Bš¬yFunùiÚ
;

22 
Çme¥aû
 
	g¥
 {

24 
SpCÚ‹xt
* 
g_cÚ‹xt
;

31 
size_t


32 
	gSpSn³t
::
em™_§ve
(* 
buf
, 
size_t
 
off£t
, 
boŞ
 
šdœeù
) {

33 * 
	gp
 = 
buf
 + 
off£t
;

36 *
	gp
++ = 0x57;

37 *
	gp
++ = 0x56;

38 *
	gp
++ = 0x52;

39 *
	gp
++ = 0x51;

40 *
	gp
++ = 0x41;

41 *
	gp
++ = 0x50;

42 *
	gp
++ = 0x41;

43 *
	gp
++ = 0x51;

44 *
	gp
++ = 0x50;

48 
	gp
 +ğ
em™_§ve_¥
(
p
, 0);

51 ià(
	gšdœeù
) {

52 *
	gp
++ = 0x41;

53 *
	gp
++ = 0x52;

54 *
	gp
++ = 0x41;

55 *
	gp
++ = 0x53;

56 *
	gp
++ = 0x53;

57 *
	gp
++ = 0x41;

58 *
	gp
++ = 0x54;

59 *
	gp
++ = 0x41;

60 *
	gp
++ = 0x55;

61 *
	gp
++ = 0x41;

62 *
	gp
++ = 0x56;

63 *
	gp
++ = 0x41;

64 *
	gp
++ = 0x57;

65 *
	gp
++ = 0x55;

68  (
	gp
 - (
	gbuf
 + 
	goff£t
));

72 
size_t


73 
	gSpSn³t
::
em™_»¡Üe
(* 
buf
, 
size_t
 
off£t
, 
boŞ
 
šdœeù
) {

74 * 
	gp
 = 
buf
 + 
off£t
;

77 ià(
	gšdœeù
) {

78 *
	gp
++ = 0x5d;

79 *
	gp
++ = 0x41;

80 *
	gp
++ = 0x5f;

81 *
	gp
++ = 0x41;

82 *
	gp
++ = 0x5e;

83 *
	gp
++ = 0x41;

84 *
	gp
++ = 0x5d;

85 *
	gp
++ = 0x41;

86 *
	gp
++ = 0x5c;

87 *
	gp
++ = 0x5b;

88 *
	gp
++ = 0x41;

89 *
	gp
++ = 0x5b;

90 *
	gp
++ = 0x41;

91 *
	gp
++ = 0x5a;

95 *
	gp
++ = 0x58;

96 *
	gp
++ = 0x41;

97 *
	gp
++ = 0x59;

98 *
	gp
++ = 0x41;

99 *
	gp
++ = 0x58;

100 *
	gp
++ = 0x59;

101 *
	gp
++ = 0x5a;

102 *
	gp
++ = 0x5e;

103 *
	gp
++ = 0x5f;

105  (
	gp
 - (
	gbuf
 + 
	goff£t
));

112 
size_t


113 
	gSpSn³t
::
em™_§ve_¥
(* 
buf
, 
size_t
 
off£t
) {

114 * 
	gp
 = 
buf
 + 
off£t
;

117 *
	gp
++ = 0x48;

118 *
	gp
++ = 0xb8;

119 * 
	gl
 = (*)
p
;

120 *
	gl
 = ()&
§ved_cÚ‹xt_loc_
;

121 
	gp
 += ();

124 *
	gp
++ = 0x48;

125 *
	gp
++ = 0x89;

126 *
	gp
++ = 0x20;

128  (
	gp
 - (
	gbuf
 + 
	goff£t
));

132 
size_t


133 
	gSpSn³t
::
em™_çuÉ
(* 
buf
, 
size_t
 
off£t
) {

134 * 
	gp
 = 
buf
 + 
off£t
;

137 *
	gp
++ = ()0x48;

138 *
	gp
++ = ()0xc7;

139 *
	gp
++ = ()0x04;

140 *
	gp
++ = ()0x25;

141 *
	gp
++ = ()0x00;

142 *
	gp
++ = ()0x00;

143 *
	gp
++ = ()0x00;

144 *
	gp
++ = ()0x00;

145 *
	gp
++ = ()0x00;

146 *
	gp
++ = ()0x00;

147 *
	gp
++ = ()0x00;

148 *
	gp
++ = ()0x00;

149  (
	gp
 - (
	gbuf
 + 
	goff£t
));

153 
size_t


154 
em™_mov_imm64_rdi
(
imm
, * 
buf
, 
size_t
 
off£t
) {

155 * 
	gp
 = 
buf
 + 
off£t
;

157 *
	gp
 = ()0x48;…++;

158 *
	gp
 = ()0xbf;…++;

159 *((*)
	gp
èğ()
imm
;

164 
size_t


165 
em™_mov_imm64_rsi
(
imm
, * 
buf
, 
size_t
 
off£t
) {

166 * 
	gp
 = 
buf
 + 
off£t
;

168 *
	gp
 = ()0x48;…++;

169 *
	gp
 = ()0xbe;…++;

170 *((*)
	gp
èğ()
imm
;

178 
size_t


179 
	gSpSn³t
::
em™_·ss_·¿m
(
pošt
, 
·ylßd
, * 
buf
, 
size_t
 
off£t
) {

180 * 
	gp
 = 
buf
 + 
off£t
;

181 
size_t
 
	gš¢size
 = 0;

184 
	gš¢size
 = 
em™_mov_imm64_rdi
(()
pošt
, 
p
, 0);

185 
	gp
 +ğ
š¢size
;

187 ià(
	g·ylßd
) {

189 
	gš¢size
 = 
em™_mov_imm64_rsi
(()
·ylßd
, 
p
, 0);

190 
	gp
 +ğ
š¢size
;

193  (
	gp
 - (
	gbuf
 + 
	goff£t
));

197 
size_t


198 
em™_push_imm64
(
imm
, * 
buf
, 
size_t
 
off£t
) {

199 * 
	gp
 = 
buf
 + 
off£t
;

207 
	gi
 = 3; i >= 0; i--) {

208 
	gwÜd
 = 
¡©ic_ÿ¡
<>((
imm
 >> (16 * 
i
)) & 0xffff);

209 *
	gp
++ = 0x66;

210 *
	gp
++ = 0x68;

211 *(*)
	gp
 = 
wÜd
;

212 
	gp
 += 2;

214  (
	gp
 - (
	gbuf
 + 
	goff£t
));

218 
size_t


219 
	gSpSn³t
::
em™_ÿÎ_abs
(
ÿÎ“
, * 
buf
, 
size_t
 
off£t
, 
boŞ
) {

220 * 
	gp
 = 
buf
 + 
off£t
;

221 
Add»ss
 
	g»ddr
 = (Add»ss)
p
+5;

222 
Add»ss
 
	g»l_addr
 = (
ÿÎ“
 - 
»ddr
);

224 ià(
	g¥
::
is_di¥32
(
»l_addr
)) {

228 *
p
++ = 0xe8;

229 * 
	g»l_p
 = (*)
p
;

230 *
	g»l_p
 = 
»l_addr
;

231 
	gp
 += 4;

236 *
	gp
++ = 0x48;

237 *
	gp
++ = 0xb8;

238 * 
	gÿÎ_addr
 = (*)
p
;

239 *
	gÿÎ_addr
 = 
ÿÎ“
;

240 
	gp
 += ();

243 *
	gp
++ = 0xff;

244 *
	gp
++ = 0xd0;

247  (
	gp
 - (
	gbuf
 + 
	goff£t
));

251 
size_t


252 
	gSpSn³t
::
em™_jump_abs
(
Œg
, * 
buf
, 
size_t
 
off£t
, 
boŞ
 
abs
) {

253 * 
	gp
 = 
buf
 + 
off£t
;

254 
size_t
 
	gš¢size
 = 0;

256 
Add»ss
 
	g»ddr
 = (Add»ss)
p
+5;

257 
Add»ss
 
	g»l_addr
 = (
Œg
 - 
»ddr
);

259 ià(
	g¥
::
is_di¥32
(
»l_addr
è&& !
abs
) {

263 *
p
++ = 0xe9;

264 * 
	g»l_p
 = (*)
p
;

265 *
	g»l_p
 = 
»l_addr
;

266 
	gp
 += 4;

271 
	gš¢size
 = 
em™_push_imm64
(
Œg
, 
p
, 0);

272 
	gp
 +ğ
š¢size
;

275 *
	gp
++ = 0xc3;

277  (
	gp
 - (
	gbuf
 + 
	goff£t
));

285 
Add»ss


286 
	gSpSn³t
::
g‘_´e_sigÇl_pc
(* 
cÚ‹xt
) {

287 
ucÚ‹xt_t
* 
ùx
 = (ucÚ‹xt_t*)
cÚ‹xt
;

288  
	gùx
->
	guc_mcÚ‹xt
.
	gg»gs
[
REG_RIP
];

292 
Add»ss


293 
	gSpSn³t
::
£t_pc
(
Add»ss
 
pc
, * 
cÚ‹xt
) {

294 
ucÚ‹xt_t
* 
	gùx
 = (ucÚ‹xt_t*)
cÚ‹xt
;

295 
	gùx
->
	guc_mcÚ‹xt
.
	gg»gs
[
REG_RIP
] = 
pc
;

299 
Add»ss


300 
	gSpSn³t
::
g‘_§ved_»g
(
Dynš¡
::
MachRegi¡”
 
»g
) {

302 
	#RAX
 (0)

	)

303 
	#R9
 (8)

	)

304 
	#R8
 (16)

	)

305 
	#RCX
 (24)

	)

306 
	#RDX
 (32)

	)

307 
	#RSI
 (40)

	)

308 
	#RDI
 (48)

	)

309 
	#RSP
 (56)

	)

311 
	#R10
 (-8)

	)

312 
	#R11
 (-16)

	)

313 
	#RBX
 (-24)

	)

314 
	#R12
 (-32)

	)

315 
	#R13
 (-40)

	)

316 
	#R14
 (-48)

	)

317 
	#R15
 (-56)

	)

318 
	#RBP
 (-64)

	)

320 
	#»g_v®
(
i
è(*(*)(
§ved_cÚ‹xt_loc_
+()(i)))

	)

327 
usšg
 
Çme¥aû
 
Dynš¡
::
x86_64
;

329 ià(
	g»g
 =ğ
¿x
è 
»g_v®
(
RAX
);

330 ià(
	g»g
 =ğ
rbx
è 
»g_v®
(
RBX
);

331 ià(
	g»g
 =ğ
rcx
è 
»g_v®
(
RCX
);

332 ià(
	g»g
 =ğ
rdx
è 
»g_v®
(
RDX
);

333 ià(
	g»g
 =ğ
rsi
è 
»g_v®
(
RSI
);

334 ià(
	g»g
 =ğ
rdi
è 
»g_v®
(
RDI
);

335 ià(
	g»g
 =ğ
r8
è 
»g_v®
(
R8
);

336 ià(
	g»g
 =ğ
r9
è 
»g_v®
(
R9
);

337 ià(
	g»g
 =ğ
r10
è 
»g_v®
(
R10
);

338 ià(
	g»g
 =ğ
r11
è 
»g_v®
(
R11
);

339 ià(
	g»g
 =ğ
r12
è 
»g_v®
(
R12
);

340 ià(
	g»g
 =ğ
r13
è 
»g_v®
(
R13
);

341 ià(
	g»g
 =ğ
r14
è 
»g_v®
(
R14
);

342 ià(
	g»g
 =ğ
r15
è 
»g_v®
(
R15
);

343 ià(
	g»g
 =ğ
r¥
è (
§ved_cÚ‹xt_loc_
+
RSP
);

345 ià(
	g»g
 =ğ
rbp
è 
»g_v®
(
RBP
);

347 ià(
	g»g
 =ğ
—x
è 
»g_v®
(
RAX
);

348 ià(
	g»g
 =ğ
ebx
è 
»g_v®
(
RBX
);

349 ià(
	g»g
 =ğ
ecx
è 
»g_v®
(
RCX
);

350 ià(
	g»g
 =ğ
edx
è 
»g_v®
(
RDX
);

351 ià(
	g»g
 =ğ
esi
è 
»g_v®
(
RSI
);

352 ià(
	g»g
 =ğ
edi
è 
»g_v®
(
RDI
);

353 ià(
	g»g
 =ğ
e¥
è (
§ved_cÚ‹xt_loc_
+
RSP
);

355 ià(
	g»g
 =ğ
ebp
è 
»g_v®
(
RBP
);

361 
boŞ


362 
	gSpP¬£r
::
is_pc
(
Dynš¡
::
MachRegi¡”
 
r
) {

363 ià(
r
 =ğ
Dynš¡
::
x86_64
::
r
è 
Œue
;

364  
	gçl£
;

367 şas 
	cR–ocVis™Ü
 : 
public
 
Vis™Ü
 {

368 
public
:

369 
R–ocVis™Ü
(
SpP¬£r
::
±r
 
p
è: 
Vis™Ü
(), 
p_
Õ), 
u£_pc_
(
çl£
) {}

370 
vœtu®
 
vis™
(
Regi¡”AST
* 
r
) {

371 ià(
	gp_
->
is_pc
(
r
->
g‘ID
())) {

372 
	gu£_pc_
 = 
Œue
;

375 
vœtu®
 
vis™
(
Bš¬yFunùiÚ
* 
b
) {

377 
vœtu®
 
vis™
(
ImmedŸ‹
* 
i
) {

379 
vœtu®
 
vis™
(
D”eã»nû
* 
d
) {

381 
boŞ
 
u£_pc
(ècÚ¡ {  
	gu£_pc_
; }

382 
	g´iv©e
:

383 
SpP¬£r
::
±r
 
p_
;

384 
boŞ
 
	gu£_pc_
;

417 
g‘_di¥
(
In¡ruùiÚ
::
PŒ
 
š¢
, * 
š¢_buf
) {

418 * 
	gdi¥
 = 
NULL
;

420 
	gdi¥_off£t
 = 0;

422 ià((
	gš¢_buf
[
di¥_off£t
] & 0xf0) == 0x40) {

423 ++
di¥_off£t
;

427 ià(
	gš¢_buf
[
di¥_off£t
] == 0x0f) {

428 ++
di¥_off£t
;

432 ++
	gdi¥_off£t
;

435 ++
	gdi¥_off£t
;

437 
	gdi¥
 = (*)&
š¢_buf
[
di¥_off£t
];

438  
	gdi¥
;

442 şas 
	cEmuVis™Ü
 : 
public
 
Vis™Ü
 {

443 
public
:

444 
EmuVis™Ü
(
Add»ss
 
a
)

445 : 
Vis™Ü
(), 
imm_
(0), 
a_
(
a
) { }

446 
vœtu®
 
vis™
(
Regi¡”AST
* 
r
) {

448 
	gimm_
 = 
a_
;

449 
	g¡ack_
.
push
(
imm_
);

451 
vœtu®
 
vis™
(
Bš¬yFunùiÚ
* 
b
) {

452 
Add»ss
 
	gi1
 = 
¡ack_
.
tİ
();

453 
	g¡ack_
.
pİ
();

454 
Add»ss
 
	gi2
 = 
¡ack_
.
tİ
();

455 
	g¡ack_
.
pİ
();

457 ià(
	gb
->
isAdd
()) {

458 
	gimm_
 = 
i1
 + 
i2
;

459 } ià(
	gb
->
isMuÉly
()) {

460 
	gimm_
 = 
i1
 * 
i2
;

462 
as£¹
(0);

464 
	g¡ack_
.
push
(
imm_
);

466 
vœtu®
 
vis™
(
ImmedŸ‹
* 
i
) {

467 
ResuÉ
 
	g»s
 = 
i
->
ev®
();

468 
	g»s
.
size
()) {

470 
imm_
 =
»s
.
v®
.
u8v®
;

474 
imm_
 =
»s
.
v®
.
u16v®
;

478 
imm_
 =
»s
.
v®
.
u32v®
;

482 
imm_
 =
»s
.
v®
.
u64v®
;

486 
	g¡ack_
.
push
(
imm_
);

488 
vœtu®
 
vis™
(
D”eã»nû
* 
d
) {

493 
Add»ss
 
imm
() const {

494  
	gimm_
;

497 
	g´iv©e
:

498 
¡d
::
¡ack
<
Add»ss
> 
¡ack_
;

499 
Add»ss
 
	gimm_
;

500 
Add»ss
 
	ga_
;

516 
size_t


517 
emuÏ‹_pc£n
(
In¡ruùiÚ
::
PŒ
 
š¢
, 
Ex´essiÚ
::PŒ 
e
, 
Add»ss
 
a
, * 
buf
) {

518 * 
	gp
 = 
buf
;

519 * 
	gš¢_buf
 = (*)
š¢
->
±r
();

524 
	g»x
 = 0;

525 
	gmodrm_off£t
 = 1;

526 ià((
	gš¢_buf
[0] & 0xf0) == 0x40) {

527 
»x
 = 
š¢_buf
[0];

528 ++
	gmodrm_off£t
;

531 
	gesÿ³
 = 0;

532 ià(
	gš¢_buf
[
modrm_off£t
-1] == 0x0f) {

533 
esÿ³
 = 0x0f;

534 ++
	gmodrm_off£t
;

538 
	gmodrm
 = 
š¢_buf
[
modrm_off£t
];

541 
	g»g
 = 0;

542 ià(
	g»x
) {

544 ià(
	g»x
 & 0x04è
	g»g
 |= 0x08;

546 
	g»g
 |ğ((
modrm
 & 0x38) >> 3);

551 ià(
	g»g
 != 0x08) {

553 *
p
++ = 0x41;

554 *
	gp
++ = 0x50;

557 *
	gp
++ = 0x41;

558 *
	gp
++ = 0x51;

564 *
	gp
++ = 0x49;

565 ià(
	g»g
 != 0x08) {

566 *
p
++ = 0xb8;

568 *
	gp
++ = 0xb9;

570 * 
	gl
 = (*)
p
;

573 
EmuVis™Ü
 
vis™Ü
(
a
+
š¢
->
size
());

574 
	ge
->
­¶y
(&
vis™Ü
);

575 *
	gl
 = 
vis™Ü
.
imm
();

576 
	gp
 +ğ(
l
);

579 ià(
	g»x
) {

580 
	g»x
 |= 0x01;

581 *
	gp
++ = 
»x
;

583 *
	gp
++ = 0x41;

587 ià(
	gesÿ³
) {

588 *
	gp
++ = 0x0f;

592 *
	gp
++ = 
š¢_buf
[
modrm_off£t
-1];

593 
	gÃw_modrm
 = 
modrm
;

594 ià(
	g»g
 != 0x08) {

595 
Ãw_modrm
 &= 0xf8;

597 
	gÃw_modrm
 &= 0xf9;

599 *
	gp
++ = 
Ãw_modrm
;

602 
	gi
 = 
modrm_off£t
+1+4; i < 
	gš¢
->
size
(); i++) {

603 *
	gp
++ = 
š¢_buf
[
i
];

609 ià(
	g»g
 != 0x08) {

611 *
p
++ = 0x41;

612 *
	gp
++ = 0x58;

615 *
	gp
++ = 0x41;

616 *
	gp
++ = 0x59;

619  (
	gsize_t
)(
	gp
 - 
	gbuf
);

622 
size_t


623 
»loc_š¢_š‹º®
(
Add»ss
 
a
, 
In¡ruùiÚ
::
PŒ
 
š¢
,

624 
¡d
::
£t
<
Ex´essiÚ
::
PŒ
>& 
exp
, 
boŞ
 
u£_pc
, * 
p
) {

625 ià(
	gu£_pc
) {

627 
	gš¢_buf
[20];

628 
memıy
(
š¢_buf
, 
š¢
->
±r
(), in¢->
size
());

629 * 
	gdis_buf
 = 
g‘_di¥
(
š¢
, 
š¢_buf
);

630 
	gŞd_r
 = 
a
;

631 
	gÃw_r
 = ()
p
;

632 
	gŞd_dis
 = *
dis_buf
;

633 
	glÚg_Ãw_dis
 = (
Şd_r
 - 
Ãw_r
è+ *
dis_buf
;

635 ià(
	g¥
::
is_di¥32
(
lÚg_Ãw_dis
)) {

637 *
dis_buf
 = ()
lÚg_Ãw_dis
;

638 
memıy
(
p
, 
š¢_buf
, 
š¢
->
size
());

639  
	gš¢
->
size
();

642 
size_t
 
	gš¢_size
 = 
emuÏ‹_pc£n
(
š¢
, *
exp
.
begš
(), 
a
, 
p
);

643  
	gš¢_size
;

647 
memıy
(
p
, 
š¢
->
±r
(), in¢->
size
());

648  
	gš¢
->
size
();

653 
size_t


654 
	gSpSn³t
::
»loc_š¢
(
Add»ss
 
¤c_š¢
, 
In¡ruùiÚ
::
PŒ
 
š¢
,

655 
Add»ss
 
Ï¡
, * 
buf
) {

657 ià(
	g¤c_š¢
 =ğ
Ï¡
) {  0; }

660 
	g£t
<
	gEx´essiÚ
::
PŒ
> 
İS‘
;

661 ià(
	gš¢
->
»adsMemÜy
()èš¢->
g‘MemÜyR—dO³¿nds
(
İS‘
);

662 ià(
	gš¢
->
wr™esMemÜy
()èš¢->
g‘MemÜyWr™eO³¿nds
(
İS‘
);

664 
boŞ
 
	gu£_pc
 = 
çl£
;

665 
	g£t
<
	gEx´essiÚ
::
PŒ
>::
™”©Ü
 
i
 = 
İS‘
.
begš
(); 
	gi
 !ğİS‘.
’d
(); i++) {

666 
R–ocVis™Ü
 
vis™Ü
(
cÚ‹xt_
->
·r£r
());

667 (*
	gi
)->
­¶y
(&
vis™Ü
);

668 
	gu£_pc
 = 
vis™Ü
.
u£_pc
();

672  
»loc_š¢_š‹º®
(
¤c_š¢
, 
š¢
, 
İS‘
, 
u£_pc
, 
buf
);

676 
size_t


677 
	gSpSn³t
::
	$jump_abs_size
() {

681 
	}
}

686 
size_t


687 
	gSpSn³t
::
	$em™_ÿÎ_Üig
(
¤c
, 
size_t
 
size
,

688 * 
buf
, 
size_t
 
off£t
) {

689 * 
p
 = 
buf
 + 
off£t
;

690 
boŞ
 
u£_pc
 = 
çl£
;

693 
In¡ruùiÚ
::
PŒ
 
š¢
 = 
	`g‘_Üig_ÿÎ_š¢
();

694 
R–ocVis™Ü
 
	`vis™Ü
(
cÚ‹xt_
->
	`·r£r
());

695 
Ex´essiÚ
::
PŒ
 
Œg
 = 
š¢
->
	`g‘CÚŒŞFlowT¬g‘
();

696 
£t
<
Ex´essiÚ
::
PŒ
> 
İS‘
;

697 ià(
Œg
) {

698 
Œg
->
	`­¶y
(&
vis™Ü
);

699 
u£_pc
 = 
vis™Ü
.
	`u£_pc
();

700 
İS‘
.
	`š£¹
(
Œg
);

702  
	`»loc_š¢_š‹º®
(
¤c
, 
š¢
, 
İS‘
, 
u£_pc
, 
p
);

703 
	}
}

707 
	gSpSn³t
::
	$pİ_¬gum’t
(
Argum’tHªdË
* 
h
, 
size_t
 
size
) {

708 
usšg
 
Çme¥aû
 
Dynš¡
::
x86_64
;

709 ià(
h
->
num
 < 6) {

710 
Add»ss
 
a
 = 0;

711 
h
->
num
) {

713 
a
 = 
	`g‘_§ved_»g
(
rdi
);

716 
a
 = 
	`g‘_§ved_»g
(
rsi
);

719 
a
 = 
	`g‘_§ved_»g
(
rdx
);

722 
a
 = 
	`g‘_§ved_»g
(
rcx
);

725 
a
 = 
	`g‘_§ved_»g
(
r8
);

728 
a
 = 
	`g‘_§ved_»g
(
r9
);

731 
	`as£¹
(0);

733 * 
b
 = 
h
->
	`š£¹_buf
(
size
);

734 
	`memıy
(
b
, &
a
, 
size
);

735 ++
h
->
num
;

736  
b
;

739 * 
a
 = (*)(
§ved_cÚ‹xt_loc_
 + 
RSP
 + 
h
->
off£t
);

740 
h
->
off£t
 +ğ
size
;

741 ++
h
->
num
;

742  
a
;

743 
	}
}

747 
	gSpSn³t
::
	$g‘_»t_v®
() {

748  
	`g‘_§ved_»g
(
Dynš¡
::
x86_64
::
¿x
);

749 
	}
}

	@SpContext.C

1 
	~"SpCÚ‹xt.h
"

2 
	~"SpPrİ–Ër.h
"

3 
	~"SpP¬£r.h
"

4 
	~"SpUts.h
"

7 
usšg
 
	gsk
::
F¿me
;

8 
usšg
 
	gsk
::
W®k”
;

10 
usšg
 
	gsb
::
Symb
;

12 
usšg
 
	g¥
::
SpP¬£r
;

13 
usšg
 
	g¥
::
SpCÚ‹xt
;

14 
usšg
 
	g¥
::
SpPrİ–Ër
;

16 
usšg
 
	gph
::
Pošt
;

17 
usšg
 
	gph
::
P©chMgr
;

18 
usšg
 
	gph
::
AddrS·û
;

19 
usšg
 
	gph
::
P©chObjeù
;

20 
usšg
 
	gph
::
P©chMgrPŒ
;

21 
usšg
 
	gph
::
P©chFunùiÚ
;

23 
usšg
 
	g³
::
SymbCodeSourû
;

26 
	gSpCÚ‹xt
::
SpCÚ‹xt
(
SpPrİ–Ër
::
±r
 
p
,

27 
SpP¬£r
::
±r
 
·r£r
) {

28 
š™_´İ–Ër_
 = 
p
;

29 
	g·r£r_
 = 
·r£r
;

30 
	gc_mgr_
 = 
NULL
;

31 
	g®low_c_
 = 
çl£
;

34 
·r£
();

36 
š™_w–l_known_libs
();

39 
SpCÚ‹xt
*

40 
	gSpCÚ‹xt
::
ü—‹
(
SpPrİ–Ër
::
±r
 
´İ–Ër
,

41 
¡ršg
 
š™_befÜe
,

42 
¡ršg
 
š™_aá”
,

43 
SpP¬£r
::
±r
 
·r£r
) {

44 
SpCÚ‹xt
* 
»t
 = 
Ãw
 SpCÚ‹xt(
´İ–Ër
,

45 
·r£r
);

46 
as£¹
(
»t
);

47 
	g»t
->
	gš™_befÜe_
 = (*)
»t
->
·r£r
()->
g‘_func_addr
(
š™_befÜe
);

48 
	g»t
->
	gš™_aá”_
 = (*)
»t
->
·r£r
()->
g‘_func_addr
(
š™_aá”
);

49 
	g»t
->
	gw¿µ”_befÜe_
 = (*)
»t
->
·r£r
()->
g‘_func_addr
("wrapper_before");

50 
	g»t
->
	gw¿µ”_aá”_
 = (*)
»t
->
·r£r
()->
g‘_func_addr
("wrapper_after");

51  
	g»t
;

56 
	gSpCÚ‹xt
::
	$š™_w–l_known_libs
() {

57 
w–l_known_libs_
.
	`push_back
("libc-");

58 
w–l_known_libs_
.
	`push_back
("libm-");

59 
w–l_known_libs_
.
	`push_back
("ld-");

60 
w–l_known_libs_
.
	`push_back
("libdl-");

61 
w–l_known_libs_
.
	`push_back
("libstdc++");

62 
w–l_known_libs_
.
	`push_back
("libgcc");

63 
w–l_known_libs_
.
	`push_back
("libagent.so");

64 
w–l_known_libs_
.
	`push_back
("libpthread-");

66 ià(
·r£r_
->
	`šjeùed
())

67 
w–l_known_libs_
.
	`push_back
(
·r£r_
->
	`g‘_ag’t_Çme
());

68 
	}
}

76 
P©chFunùiÚ
*

77 
	gSpCÚ‹xt
::
	$g‘_fœ¡_š¡_func
() {

79 
¡d
::
veùÜ
<
F¿me
> 
¡ackw®k
;

80 
W®k”
 *
w®k”
 = W®k”::
	`ÃwW®k”
();

81 
w®k”
->
	`w®kSck
(
¡ackw®k
);

82 
i
=0; i<
¡ackw®k
.
	`size
(); i++) {

83 
¡ršg
 
s
;

84 
¡ackw®k
[
i
].
	`g‘Name
(
s
);

85 
¡ršg
 
l
;

86 
Dynš¡
::
Off£t
 
o
;

87 * 
symobj
;

88 
¡ackw®k
[
i
].
	`g‘LibOff£t
(
l
, 
o
, 
symobj
);

89 #iâdeà
SP_RELEASE


90 
	`¥_debug
("STACKWALK - %s in†ibrary %s with offset %lx",

91 
s
.
	`c_¡r
(), 
	`¥_f’ame
(
l
.c_¡r()), 
o
);

94 ià(
	`is_w–l_known_lib
(
l
)) {

95 #iâdeà
SP_RELEASE


96 
	`¥_debug
("SKIPPED - FunùiÚ % i š w–ÈknowÀlib", 
s
.
	`c_¡r
());

102 
P©chFunùiÚ
* 
func
 = 
·r£r_
->
	`fšdFunùiÚ
(
s
);

103 ià(!
func
) {

104 #iâdeà
SP_RELEASE


105 
	`¥_debug
("SKIPPED - FunùiÚ % ÿÂÙ b»sŞved", 
s
.
	`c_¡r
());

111 #iâdeà
SP_RELEASE


112 
	`¥_debug
("FOUND - FunùiÚ % i thfœ¡ in¡rum’bË funùiÚ", 
s
.
	`c_¡r
());

114  
func
;

117  
NULL
;

118 
	}
}

121 
	gSpCÚ‹xt
::
	$·r£
() {

122 #iâdeà
SP_RELEASE


123 
	`¥_debug
("START PARSING - start…arsing binary code");

125 
mgr_
 = 
·r£r_
->
	`·r£
();

126 #iâdeà
SP_RELEASE


127 
	`¥_debug
("FINISH PARSING - finish…arsing binary code");

129 
	}
}

131 
boŞ


132 
	gSpCÚ‹xt
::
	$is_w–l_known_lib
(
¡ršg
 
lib
) {

133 
i
 = 0; i < 
w–l_known_libs_
.
	`size
(); i++) {

134 ià(
lib
.
	`fšd
(
w–l_known_libs_
[
i
]è!ğ
¡ršg
::
Åos
è 
Œue
;

136  
çl£
;

137 
	}
}

141 
	gSpCÚ‹xt
::
	$»¡Üe
() {

143 
	`sigaùiÚ
(
SIGTRAP
, &
Şd_aù_
, 
NULL
);

144 
	}
}

147 
P©chFunùiÚ
*

148 
	gSpCÚ‹xt
::
	$ÿÎ“
(
Pošt
* 
±
) {

149  
	`·r£r
()->
	`ÿÎ“
(
±
, 
dœeùÿÎ_Úly_
 =ğ
çl£
);

150 
	}
}

152 
	gSpCÚ‹xt
::~
	$SpCÚ‹xt
() {

153 
d–‘e
 
c_mgr_
;

154 
	}
}

157 
	gSpCÚ‹xt
::
	$£t_®low_c
(
boŞ
 
b
) {

158 
®low_c_
 = 
b
;

159 ià(
b
 && !
c_mgr_
) {

160 
c_mgr_
 = 
Ãw
 
	`SpIpcMgr
();

162 
	}
}

	@SpEvent.C

1 
	~"SpEv’t.h
"

2 
	~"SpCÚ‹xt.h
"

3 
	~"SpP¬£r.h
"

5 
usšg
 
	g¥
::
SpEv’t
;

6 
usšg
 
	g¥
::
SpP¬£r
;

7 
usšg
 
	g¥
::
SpCÚ‹xt
;

8 
usšg
 
	g¥
::
SyncEv’t
;

9 
usšg
 
	g¥
::
AsyncEv’t
;

10 
usšg
 
	g¥
::
SpPrİ–Ër
;

12 
usšg
 
	gph
::
P©chFunùiÚ
;

14 
Çme¥aû
 
	g¥
 {

16 
	gSpEv’t
::
SpEv’t
() {

20 
SpEv’t
::
»gi¡”_ev’t
(
SpCÚ‹xt
* 
c
) {

25 (*
ev’t_hªdËr_t
)(, 
	tsigšfo_t
*, *);

27 
SpCÚ‹xt
* 
	gg_cÚ‹xt
 = 
NULL
;

30 
async_ev’t_hªdËr
(
signum
, 
sigšfo_t
* 
šfo
, * 
cÚ‹xt
) {

31 
	g¥
::
g_cÚ‹xt
->
·r£
();

32 
P©chFunùiÚ
* 
	gf
 = 
¥
::
g_cÚ‹xt
->
g‘_fœ¡_š¡_func
();

33 
	gg_cÚ‹xt
->
š™_´İ–Ër
()->
go
(
f
, 
g_cÚ‹xt
,

34 
g_cÚ‹xt
->
š™_befÜe
(),

35 
g_cÚ‹xt
->
š™_aá”
());

38 
	gAsyncEv’t
::
AsyncEv’t
(
signum
, 
£c
)

39 : 
aá”_£cs_
(
£c
), 
signum_
(
signum
) {

40 
	ghªdËr_
 = (*)
async_ev’t_hªdËr
;

44 
	gAsyncEv’t
::
»gi¡”_ev’t
(
SpCÚ‹xt
* 
c
) {

45 
g_cÚ‹xt
 = 
c
;

46 
sigaùiÚ
 
	gaù
;

47 
	gaù
.
	g§_sigaùiÚ
 = (
ev’t_hªdËr_t
)
hªdËr_
;

48 
	gaù
.
	g§_æags
 = 
SA_SIGINFO
;

49 
sigaùiÚ
(
signum_
, &
aù
, 
NULL
);

50 ià(
	gsignum_
 =ğ
SIGALRM
è
®¬m
(
aá”_£cs_
);

55 
sync_ev’t_hªdËr
(
signum
, 
sigšfo_t
* 
šfo
, * 
cÚ‹xt
) {

56 
	gg_cÚ‹xt
->
·r£
();

57 
P©chFunùiÚ
* 
	gf
 = 
g_cÚ‹xt
->
g‘_fœ¡_š¡_func
();

58 
	gg_cÚ‹xt
->
š™_´İ–Ër
()->
go
(
f
, 
g_cÚ‹xt
,

59 
g_cÚ‹xt
->
š™_befÜe
(),

60 
g_cÚ‹xt
->
š™_aá”
());

63 
	gSyncEv’t
::
SyncEv’t
(
¡d
::
¡ršg
 
func_Çme
, 
£c
)

64 : 
AsyncEv’t
(
SIGALRM
, 
£c
), 
func_Çme_
(
func_Çme
) {

65 
	ghªdËr_
 = (*)
sync_ev’t_hªdËr
;

70 
	gSyncEv’t
::
»gi¡”_ev’t
(
SpCÚ‹xt
* 
c
) {

71 
g_cÚ‹xt
 = 
c
;

73 ià(!
	gg_cÚ‹xt
->
·r£r
()->
šjeùed
()) {

74 #iâdeà
SP_RELEASE


75 
¥_debug
("PRELOAD -…reload‡gent.so,‡nd instrument main()");

77 
P©chFunùiÚ
* 
	gf
 = 
c
->
·r£r
()->
fšdFunùiÚ
("main");

78 
	gc
->
š™_´İ–Ër
()->
go
(
f
, 
c
, c->
š™_befÜe
(), c->
š™_aá”
());

80 
sigaùiÚ
 
	gaù
;

81 
	gaù
.
	g§_sigaùiÚ
 = (
ev’t_hªdËr_t
)
hªdËr_
;

82 
	gaù
.
	g§_æags
 = 
SA_SIGINFO
;

83 
sigaùiÚ
(
signum_
, &
aù
, 
NULL
);

84 ià(
	gsignum_
 =ğ
SIGALRM
è
®¬m
(
aá”_£cs_
);

	@SpInstrumenter.C

1 
	~"SpIn¡rum’‹r.h
"

2 
	~"SpSn³t.h
"

3 
	~"SpCÚ‹xt.h
"

4 
	~"SpAddrS·û.h
"

5 
	~"SpUts.h
"

6 
	~"SpPošt.h
"

8 
usšg
 
	gdt
::
Add»ss
;

10 
usšg
 
	g¥
::
SpSn³t
;

11 
usšg
 
	g¥
::
SpCÚ‹xt
;

12 
usšg
 
	g¥
::
SpSn³t
;

13 
usšg
 
	g¥
::
SpAddrS·û
;

14 
usšg
 
	g¥
::
SpIn¡rum’‹r
;

16 
usšg
 
	gš
::
In¡ruùiÚ
;

18 
usšg
 
	gph
::
Pošt
;

19 
usšg
 
	gph
::
Sn³t
;

20 
usšg
 
	gph
::
AddrS·û
;

21 
usšg
 
	gph
::
P©chBlock
;

22 
usšg
 
	gph
::
P©chObjeù
;

23 
usšg
 
	gph
::
P©chMgrPŒ
;

24 
usšg
 
	gph
::
In¡ªûPŒ
;

25 
usšg
 
	gph
::
P©chFunùiÚ
;

26 
usšg
 
	gph
::
PushBackCommªd
;

28 
Çme¥aû
 
	g¥
 {

30 
SpCÚ‹xt
* 
g_cÚ‹xt
;

35 
SpIn¡rum’‹r
*

36 
	gSpIn¡rum’‹r
::
ü—‹
(
AddrS·û
* 
as
) {

37  
Ãw
 
SpIn¡rum’‹r
(
as
);

41 
	gSpIn¡rum’‹r
::
SpIn¡rum’‹r
(
AddrS·û
* 
as
)

42 : 
In¡rum’‹r
(
as
) {

48 
¡d
::
	tm­
<
	tAdd»ss
, 
	tSpSn³t
::
	t±r
> 
	tIn¡M­
;

49 
In¡M­
 
	gg_š¡_m­
;

55 
	gSpIn¡rum’‹r
::
Œ­_hªdËr
(
sig
, 
sigšfo_t
* 
šfo
, * 
c
) {

56 
Add»ss
 
	gpc
 = 
SpSn³t
::
g‘_´e_sigÇl_pc
(
c
) - 1;

58 
	gIn¡M­
& 
	gš¡_m­
 = 
g_š¡_m­
;

59 ià(
	gš¡_m­
.
fšd
(
pc
è=ğ
š¡_m­
.
’d
()) {

64 
	gSpSn³t
::
±r
 
¥_¢
 = 
š¡_m­
[
pc
];

65 
Pošt
* 
	g±
 = 
¥_¢
->
pošt
();

67 * 
	gblob
 = (*)
¥_¢
->
buf
();

68 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

69 
P©chMgrPŒ
 
	gmgr
 = 
g_cÚ‹xt
->
mgr
();

70 
SpAddrS·û
* 
	gas
 = 
dyÇmic_ÿ¡
<SpAddrS·û*>(
mgr
->
as
());

71 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
blob
, 
¥_¢
->
size
(), 
³rm
)) {

72 
	gas
->
dump_mem_m­s
();

73 
ex™
(0);

77 
	gSpSn³t
::
£t_pc
((
Add»ss
)
blob
, 
c
);

81 
boŞ


82 
	gSpIn¡rum’‹r
::
run
() {

85 
CommªdLi¡
::
™”©Ü
 
c
 = 
u£r_commªds_
.
begš
(); 
	gc
 !ğu£r_commªds_.
’d
(); c++) {

86 
PushBackCommªd
* 
	gcommªd
 = 
¡©ic_ÿ¡
<PushBackCommªd*>(*
c
);

88 ià(
	gcommªd
) {

89 
In¡ªûPŒ
 
	gš¡ªû
 = 
commªd
->
š¡ªû
();

90 
Pošt
* 
	g±
 = 
š¡ªû
->
pošt
();

91 
SpPošt
* 
	g¥t
 = 
¡©ic_ÿ¡
<SpPošt*>(
±
);

94 ià(!
	g±
->
g‘C®Ëe
(è&& 
	gg_cÚ‹xt
->
dœeùÿÎ_Úly
()) ;

96 #iâdeà
SP_RELEASE


97 ià(
	g¥t
->
š¡rum’‹d
()) {

98 
¥_debug
("SKIPED -…iÚˆ%lx i š¡rum’‹d, sk it", 
±
->
block
()->
Ï¡
());

101 ià(!
	g¥t
->
š¡rum’‹d
()) {

102 
	gSn³t
<
	gSpSn³t
::
±r
>::
PŒ
 
¢
 = 
Sn³t
<
SpSn³t
::±r>::
g‘
(
š¡ªû
->
¢³t
());

103 
	gSpSn³t
::
±r
 
¥_¢
 = 
¢
->
»p
();

104 
	g¥t
->
£t_¢
(
¥_¢
);

105 
Add»ss
 
	ge
 = 
±
->
block
()->
Ï¡
();

106 * 
	gš¢
 = (*)
e
;

108 
Add»ss
 
	gš¢_size
 = 
±
->
block
()->
’d
(è- 
e
;

109 
Add»ss
 
	g»t_addr
 = 
±
->
block
()->
’d
();

110 
	gIn¡ruùiÚ
::
PŒ
 
ÿÎš¢
 = 
±
->
block
()->
g‘In¢
(
e
);

113 ià(
	gÿÎš¢
->
g‘C©egÜy
(è=ğ
š
::
c_B¿nchIn¢
) {

114 #iâdeà
SP_RELEASE


115 
¥_debug
("TAIL CALL -…ošˆ%lx i ¨ c®l", 
±
->
block
()->
Ï¡
());

117 
	g¥t
->
£t_ÿÎ
(
Œue
);

118 
	g»t_addr
 = 0;

121 * 
	gblob
 = (*)
¥_¢
->
buf
();

122 
boŞ
 
	g»®loc
 = 
çl£
;

124 
	gREALLOC
:

125 
»l_addr
 = ()
blob
 - ()
e
;

130 
	g¥_¢
->
£t_Üig_ÿÎ_š¢
(
ÿÎš¢
);

133 ià((
	gš¢
[0] != ()0xe8)) {

135 
boŞ
 
jump_abs
 = 
çl£
;

136 ià(!
	g¥
::
is_di¥32
(
»l_addr
)è
jump_abs
 = 
Œue
;

139 ià(
š¡®l_šdœeù
(
¥t
, 
¥_¢
, 
jump_abs
, 
»t_addr
)) {

140 
	g¥t
->
£t_š¡rum’‹d
(
Œue
);

143 ià(!
	g»®loc
) {

144 
	g»®loc
 = 
Œue
;

145 
	gblob
 = (*)
¥_¢
->
»®loc
();

146 ià(
	gblob
è
	gREALLOC
;

149 ià(
	g»®loc
 && !
	g¥t
->
š¡rum’‹d
()) {

150 
¥_´št
("FAILEDo use JUMP - TRY TO USE TRAP");

153 
sigaùiÚ
 
	gaù
;

154 
	gaù
.
	g§_sigaùiÚ
 = 
SpIn¡rum’‹r
::
Œ­_hªdËr
;

155 
	gaù
.
	g§_æags
 = 
SA_SIGINFO
;

156 
sigaùiÚ
 
	gŞd_aù
;

157 
sigaùiÚ
(
SIGTRAP
, &
aù
, &
Şd_aù
);

159 
	gg_š¡_m­
[
e
] = 
¥_¢
;

160 
	gblob
 = 
¥_¢
->
blob
(
»t_addr
);

162 ià(
š¡®l_Œ­
(
¥t
, 
blob
, 
¥_¢
->
size
())) {

163 
	g¥t
->
£t_š¡®l_m‘hod
(
SP_TRAP
);

164 
	g¥t
->
£t_š¡rum’‹d
(
Œue
);

166 
¥_´št
("FAILEDo use TRAP,‚o instrumentation forhis…oint");

173 
	gblob
 = 
¥_¢
->
blob
(
»t_addr
);

175 ià(
š¡®l_dœeù
(
¥t
, 
blob
, 
¥_¢
->
size
())) {

176 
	g¥t
->
£t_š¡®l_m‘hod
(
SP_RELOC_INSN
);

177 
	g¥t
->
£t_š¡rum’‹d
(
Œue
);

179 
¥_´št
("FAILED - Failedo install instrumentation‡t %lx for calling %s",

180 
±
->
block
()->
Ï¡
(), 
g_cÚ‹xt
->
·r£r
()->
ÿÎ“
Õt)->
Çme
().
c_¡r
());

186 
	gu£r_commªds_
.
ş—r
();

188  
	gŒue
;

191 
boŞ


192 
	gSpIn¡rum’‹r
::
š¡®l_dœeù
(
SpPošt
* 
pošt
, * 
blob
, 
size_t
 
blob_size
) {

194 
	gjump
[5];

195 * 
	gp
 = 
jump
;

196 *
	gp
++ = 0xe9;

197 * 
	gÍ
 = (*)
p
;

200 
P©chObjeù
* 
	gobj
 = 
pošt
->
block
()->
objeù
();

201 * 
	gaddr
 = (*)
pošt
->
block
()->
Ï¡
();

202 
size_t
 
	gš¢_Ëngth
 = 
pošt
->
block
()->
’d
(è-…ošt->block()->
Ï¡
();

203 *
	gÍ
 = ()
blob
 - ()
addr
 - 
š¢_Ëngth
;

206 
SpAddrS·û
* 
	gas
 = 
¡©ic_ÿ¡
<SpAddrS·û*>(
as_
);

207 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

208 ià(
	gas
->
£t_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_Ëngth
, 
³rm
)) {

209 
	gas
->
wr™e
(
obj
, (
Add»ss
)
addr
, (Add»ss)
jump
, 5);

211 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

215 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
blob
, 
blob_size
, 
³rm
)) {

216 
¥_´št
("MPROTECT - FaedØchªgmemÜy‡cûs ³rmissiÚ fÜ blob‡ˆ%lx", 
blob
);

217 
	gas
->
dump_mem_m­s
();

218 
ex™
(0);

222 ià(!
	gas
->
»¡Üe_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_Ëngth
)) {

223 
¥_´št
("MPROTECT - Failedo„estore memory‡ccess…ermission");

226  
	gŒue
;

229 
boŞ


230 
	gSpIn¡rum’‹r
::
š¡®l_šdœeù
(
SpPošt
* 
pošt
, 
SpSn³t
::
±r
 
¢
,

231 
boŞ
 
jump_abs
, 
Add»ss
 
»t_addr
) {

232 
P©chBlock
* 
	gblk
 = 
pošt
->
block
();

233 
size_t
 
	gblk_size
 = 
blk
->
size
();

234 
	g¡ršg
& 
	gÜig_blk
 = 
¢
->
Üig_blk
();

236 * 
	g¿w_blk
 = (*)
blk
->
¡¬t
();

237 
	gi
 = 0; i < 
	gblk_size
; i++) {

238 
	gÜig_blk
 +ğ
¿w_blk
[
i
];

241 
size_t
 
	glim™
 = 0;

242 * 
	gaddr
 = 
NULL
;

244 
SpAddrS·û
* 
	gas
 = 
¡©ic_ÿ¡
<SpAddrS·û*>(
as_
);

245 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

247 
	gš¢
[64];

248 ià(!
	gjump_abs
) {

250 
	glim™
 = 5;

251 * 
	gp
 = 
š¢
;

252 *
	gp
++ = 0xe9;

253 * 
	gÍ
 = (*)
p
;

254 *
	gÍ
 = ()
¢
->
buf
(è- ()
blk
->
¡¬t
() - 5;

256 
	glim™
 = 
¢
->
jump_abs_size
();

258 
	g¡©ic_ÿ¡
<
	gSpPošt
*>(
	gpošt
)->
¢
()->
em™_jump_abs
(()¢->
buf
(), 
š¢
, 0, 
Œue
);

261 ià(
	gblk_size
 >ğ
lim™
) {

262 
pošt
->
£t_š¡®l_m‘hod
(
SP_RELOC_BLK
);

263  
š¡®l_jump
(
blk
, 
š¢
, 
lim™
, 
¢
, 
»t_addr
);

266 
	gpošt
->
£t_š¡®l_m‘hod
(
SP_SPRINGBOARD
);

267  
š¡®l_¥ršg
(
blk
, 
¢
, 
»t_addr
);

270 
boŞ


271 
	gSpIn¡rum’‹r
::
š¡®l_jump
(
P©chBlock
* 
blk
,

272 * 
š¢
, 
size_t
 
š¢_size
,

273 
SpSn³t
::
±r
 
¢
,

274 
Add»ss
 
»t_addr
) {

277 * 
	gblob
 = 
¢
->
blob
(
»t_addr
, 
Œue
);

279 
P©chObjeù
* 
	gobj
 = 
blk
->
obj
();

280 
SpAddrS·û
* 
	gas
 = 
¡©ic_ÿ¡
<SpAddrS·û*>(
as_
);

281 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

282 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
blob
, 
¢
->
size
(), 
³rm
)) {

283 
¥_´št
("MPROTECT - FaedØchªgmemÜy‡cûs ³rmissiÚ fÜ blob‡ˆ%lx", 
blob
);

284 
	gas
->
dump_mem_m­s
();

285 
ex™
(0);

288 * 
	gaddr
 = (*)
blk
->
¡¬t
();

291 ià(
	gas
->
£t_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_size
, 
³rm
)) {

292 
	gas
->
wr™e
(
obj
, (
Add»ss
)
addr
, (Add»ss)
š¢
, 
š¢_size
);

294 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

298 ià(!
	gas
->
»¡Üe_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_size
)) {

299 
¥_´št
("MPROTECT - Failedo„estore memory‡ccess…ermission");

301 #iâdeà
SP_RELEASE


302 
¥_debug
("USE BLK-RELOC -…iÚˆ%lx i š¡rum’‹d usšg c®Èblock„–oÿtiÚ", 
blk
->
Ï¡
());

304  
	gŒue
;

308 
boŞ


309 
	gSpIn¡rum’‹r
::
š¡®l_¥ršg
(
P©chBlock
* 
ÿÎblk
,

310 
SpSn³t
::
±r
 
¢
,

311 
Add»ss
 
»t_addr
) {

319 
P©chBlock
* 
	g¥ršgblk
 = 
¢
->
¥ršg_blk
();

320 ià(!
	g¥ršgblk
è 
	gçl£
;

323 * 
	gblob
 = 
¢
->
blob
(
»t_addr
, 
Œue
,rue);

324 
P©chObjeù
* 
	gobj
 = 
ÿÎblk
->
obj
();

325 
SpAddrS·û
* 
	gas
 = 
¡©ic_ÿ¡
<SpAddrS·û*>(
as_
);

326 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

327 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
blob
, 
¢
->
size
(), 
³rm
)) {

328 
¥_´št
("MPROTECT - FaedØchªgmemÜy‡cûs ³rmissiÚ fÜ blob‡ˆ%lx", 
blob
);

329 
	gas
->
dump_mem_m­s
();

330 
ex™
(0);

334 * 
	g¥ršg
 = 
¢
->
¥ršg
(
¥ršgblk
->
Ï¡
());

335 
	gobj
 = 
¥ršgblk
->
obj
();

336 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
¥ršg
, 
¢
->
¥ršg_size
(), 
³rm
)) {

337 
¥_´št
("MPROTECT - FaedØchªgmemÜy‡cûs ³rmissiÚ fÜ„–oÿ‹d s´šg blk‡ˆ%lx", 
¥ršg
);

338 
	gas
->
dump_mem_m­s
();

339 
ex™
(0);

348 
	g¥ršgblk_š¢
[64];

351 
size_t
 
	goff
 = 0;

352 
size_t
 
	gisize
 = 
¢
->
em™_jump_abs
(()
¥ršg
, 
¥ršgblk_š¢
, 
off
, 
Œue
);

353 
	goff
 +ğ
isize
;

354 
size_t
 
	gÿÎ_blk_jmp_Œg
 = 
off
;

355 
	goff
 = 
¢
->
em™_jump_abs
(()
blob
, 
¥ršgblk_š¢
, 
off
, 
Œue
);

356 
	goff
 +ğ
isize
;

359 * 
	gaddr
 = (*)
¥ršgblk
->
¡¬t
();

360 ià(
	gas
->
£t_¿nge_³rm
((
Add»ss
)
addr
, 
¥ršgblk
->
size
(), 
³rm
)) {

361 
	gas
->
wr™e
(
obj
, (
Add»ss
)
addr
, (Add»ss)
¥ršgblk_š¢
, 
off
);

363 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

366 ià(!
	gas
->
»¡Üe_¿nge_³rm
((
Add»ss
)
addr
, 
¥ršgblk
->
size
())) {

367 
¥_´št
("MPROTECT - Failedo„estore memory‡ccess…ermission");

375 
	gaddr
 = (*)
ÿÎblk
->
¡¬t
();

376 
	gÿÎblk_š¢
[2];

377 
	gÿÎblk_š¢
[0] = 0xeb;

378 
	gÿÎblk_š¢
[1] = ()(
¥ršgblk
->
¡¬t
(è+ 
ÿÎ_blk_jmp_Œg
 - (()
addr
 + 2));

380 ià(
	gas
->
£t_¿nge_³rm
((
Add»ss
)
addr
, 
ÿÎblk
->
size
(), 
³rm
)) {

381 
	gas
->
wr™e
(
obj
, (
Add»ss
)
addr
, (Add»ss)
ÿÎblk_š¢
, 2);

383 
¥_´št
("MPROTECT - Failedo change memory‡ccess…ermission");

386 ià(!
	gas
->
»¡Üe_¿nge_³rm
((
Add»ss
)
addr
, 
ÿÎblk
->
size
())) {

387 
¥_´št
("MPROTECT - Failedo„estore memory‡ccess…ermission");

389 #iâdeà
SP_RELEASE


390 
¥_debug
("USE SPRING -…iont %lx is instrumented using 1-hop spring",

391 
ÿÎblk
->
Ï¡
());

394  
	gŒue
;

398 
boŞ


399 
	gSpIn¡rum’‹r
::
š¡®l_Œ­
(
SpPošt
* 
pošt
, * 
blob
, 
size_t
 
blob_size
) {

401 
¡ršg
 
	gšt3
;

402 
	gšt3
 += ()0xcc;

404 
P©chObjeù
* 
	gobj
 = 
pošt
->
block
()->
objeù
();

405 * 
	gaddr
 = (*)
pošt
->
block
()->
Ï¡
();

406 
size_t
 
	gš¢_Ëngth
 = 
pošt
->
block
()->
’d
(è-…ošt->block()->
Ï¡
();

407 
	gi
 = 0; i < (
	gš¢_Ëngth
-1); i++) {

408 
	gšt3
 += ()0x90;

412 
SpAddrS·û
* 
	gas
 = 
dyÇmic_ÿ¡
<SpAddrS·û*>(
as_
);

413 
	g³rm
 = 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
;

414 ià(!
	gas
->
£t_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_Ëngth
, 
³rm
)) {

415  
	gçl£
;

417 
	gas
->
wr™e
(
obj
, (
Add»ss
)
addr
, (Add»ss)
št3
.
c_¡r
(), iÁ3.
size
());

421 ià(!
	gas
->
»¡Üe_¿nge_³rm
((
Add»ss
)
addr
, 
š¢_Ëngth
)) {

422  
	gçl£
;

424 #iâdeà
SP_RELEASE


425 
¥_debug
("USE TRAP -…iÚˆ%lx i š¡rum’‹d usšg¿p", 
pošt
->
block
()->
Ï¡
());

427  
	gŒue
;

	@SpIpcMgr.C

1 
	~"SpIpcMgr.h
"

2 
	~"SpPošt.h
"

3 
	~"SpCÚ‹xt.h
"

5 
usšg
 
	gph
::
P©chFunùiÚ
;

7 
Çme¥aû
 
	g¥
 {

9 
SpCÚ‹xt
* 
g_cÚ‹xt
;

11 
	#TRACING_ID
 1987

	)

12 
	#TRACING_SIZE
 32768

	)

18 
	gSpIpcMgr
::
SpIpcMgr
() {

19 
pe_wÜk”_
 = 
Ãw
 
SpPeWÜk”
;

20 
	gwÜk”_£t_
.
š£¹
(
pe_wÜk”_
);

22 
	gtı_wÜk”_
 = 
Ãw
 
SpTıWÜk”
;

23 
	gwÜk”_£t_
.
š£¹
(
tı_wÜk”_
);

25 
	gudp_wÜk”_
 = 
Ãw
 
SpUdpWÜk”
;

26 
	gwÜk”_£t_
.
š£¹
(
udp_wÜk”_
);

29 
	gSpIpcMgr
::~
SpIpcMgr
() {

31 
d–‘e
 
pe_wÜk”_
;

32 
d–‘e
 
	gtı_wÜk”_
;

33 
d–‘e
 
	gudp_wÜk”_
;

38 
boŞ


39 
	gSpIpcMgr
::
is_pe
(
fd
) {

40 
¡©
 
s
;

41 ià(
f¡©
(
fd
, &
s
è=ğ-1è 
çl£
;

42 ià(
S_ISFIFO
(
s
.
¡_mode
)) {

43  
	gŒue
;

45  
	gçl£
;

48 
boŞ


49 
	gSpIpcMgr
::
is_£nd”
(cÚ¡ * 
f
) {

50 ià(
¡rcmp
(
f
, "write") == 0 ||

51 
¡rcmp
(
f
, "send") == 0)

52  
Œue
;

54  
	gçl£
;

57 
boŞ


58 
	gSpIpcMgr
::
is_»ûiv”
(cÚ¡ * 
f
) {

59 ià(
¡rcmp
(
f
, "read") == 0 ||

60 
¡rcmp
(
f
, "recv") == 0)

61  
Œue
;

63  
	gçl£
;

66 
boŞ


67 
	gSpIpcMgr
::
is_c
(
fd
) {

68  (
is_pe
(
fd
è|| 
is_tı
(fdè|| 
is_udp
(fd));

71 
boŞ


72 
	gSpIpcMgr
::
is_fÜk
(cÚ¡ * 
f
) {

73 ià(
¡rcmp
(
f
, "fÜk"è=ğ0è 
Œue
;

74  
	gçl£
;

77 
	gSpIpcMgr
::
¡¬t_Œacšg
() {

78 
WÜk”S‘
::
™”©Ü
 
wi
 = 
wÜk”_£t_
.
begš
(); 
	gwi
 !ğwÜk”_£t_.
’d
(); wi++) {

79 ià((*
	gwi
)->
¡¬t_Œacšg
())  1;

110 
boŞ


111 
	gSpIpcMgr
::
´e_befÜe
(
SpPošt
* 
±
) {

112 
P©chFunùiÚ
* 
f
 = 
¥
::
ÿÎ“
(
±
);

113 ià(!
	gf
è 
	gçl£
;

116 
	g¥
::
SpIpcMgr
* 
c_mgr
 = 
¥
::
g_cÚ‹xt
->ipc_mgr();

119 ià(!
	gc_mgr
->
is_£nd”
(
f
->
Çme
().
c_¡r
())) {

120 #iâdeà
SP_RELEASE


121 
¥_debug
("NON IPC FUNC - %s(èi nÙ‡ wr™Ü s’d", 
f
->
Çme
().
c_¡r
());

123  
	gŒue
;

125 #iâdeà
SP_RELEASE


126 
¥_debug
("POTENTIAL IPC - %s(èi ¨wr™Ü s’d", 
f
->
Çme
().
c_¡r
());

131 
Argum’tHªdË
 
	gh
;

132 * 
	gfd
 = (*)
¥
::
pİ_¬gum’t
(
±
, &
h
, ());

134 
SpIpcWÜk”
* 
	gwÜk”
 = 
NULL
;

137 ià(
	gc_mgr
->
is_pe
(*
fd
)) {

138 
	gwÜk”
 = 
c_mgr
->
pe_wÜk”
();

141 ià(
	gc_mgr
->
is_tı
(*
fd
)) {

142 
	gwÜk”
 = 
c_mgr
->
tı_wÜk”
();

145 ià(
	gc_mgr
->
is_udp
(*
fd
)) {

146 
	gwÜk”
 = 
c_mgr
->
udp_wÜk”
();

148  
	gŒue
;

151 
SpChªÃl
* 
	gc
 = 
wÜk”
->
g‘_chªÃl
(*
fd
);

152 ià(!
	gc
) {

156 
¥_´št
("PIPEo: %d", 
c
->
»mÙe_pid
);

157 
	gwÜk”
->
£t_¡¬t_Œacšg
(1, 
c
->
»mÙe_pid
);

163  
	gŒue
;

166 
boŞ


167 
	gSpIpcMgr
::
´e_aá”
(
SpPošt
* 
±
) {

168 
P©chFunùiÚ
* 
f
 = 
¥
::
ÿÎ“
(
±
);

169 ià(!
	gf
è 
	gçl£
;

172 
	g¥
::
SpIpcMgr
* 
c_mgr
 = 
¥
::
g_cÚ‹xt
->ipc_mgr();

174 ià(
	gc_mgr
->
is_fÜk
(
f
->
Çme
().
c_¡r
())) {

175 
	gpid
 = 
¥
::
»tv®
(
±
);

177 ià(
	gpid
 == 0) {

178 
c_mgr
->
pe_wÜk”
()->
£t_¡¬t_Œacšg
(0, 
g‘pid
());

186  
	gŒue
;

194 
	gSpPeWÜk”
::
SpPeWÜk”
() {

195 
Œacšg_š‹º®
(&
¡¬t_Œacšg_
);

196 
	g¡¬t_Œacšg_
[
g‘pid
()] = 1;

199 
	gSpPeWÜk”
::~
SpPeWÜk”
() {

200 
ChªÃlM­
::
™”©Ü
 
i
 = 
chªÃl_m­_
.
begš
(); 
	gi
 !ğchªÃl_m­_.
’d
(); i++) {

201 
d–‘e
 
	gi
->
	g£cÚd
;

206 
	gSpPeWÜk”
::
Œacšg_š‹º®
(** 
¡¬t_Œacšg
) {

207 
shmid
;

208 ià((
	gshmid
 = 
shmg‘
(
TRACING_ID
, 
TRACING_SIZE
, 
IPC_CREAT
 | 0666)) < 0) {

209 
¥_³¼Ü
("ERROR: cªnÙ c»©sh¬ed memÜy w™h id %d", 
TRACING_ID
);

212 * 
	gshm
 = 
NULL
;

213 ià(()(
	gshm
 = (*)
shm©
(
shmid
, 
NULL
, 0)) == ()-1) {

214 
¥_³¼Ü
("ERROR: cannot get shared memory");

216 *
	g¡¬t_Œacšg
 = 
shm
;

219 
	gSpPeWÜk”
::
£t_¡¬t_Œacšg
(
yes_Ü_no
, 
pid_t
 
pid
) {

220 
	g¡¬t_Œacšg_
[
pid
] = 
yes_Ü_no
;

223 
	gSpPeWÜk”
::
¡¬t_Œacšg
() {

224  
¡¬t_Œacšg_
[
g‘pid
()];

227 
boŞ
 
	gSpPeWÜk”
::
šjeù
(
SpChªÃl
*) {

232 
	gSpPeWÜk”
::
pid_u£s_šode
(
pid
, 
šode
) {

234 
	#MAXLEN
 255

	)

235 
DIR
 *
	gdœ
;

236 
	g‹mp_node
;

237 
dœ’t
 *
	gde
;

238 
	gÇme
[
MAXLEN
], 
	gbufãr
[MAXLEN];

239 
¥rštf
(
Çme
, "/´oc/%u/fd", 
pid
);

241 ià((
	gdœ
 = 
İ’dœ
(
Çme
)) == 0) {

245 (
	gde
 = 
»addœ
(
dœ
)) != 0) {

246 ià(
isdig™
(
de
->
d_Çme
[0])) {

247 
¥rštf
(
Çme
, "/´oc/%u/fd/%s", 
pid
, 
de
->
d_Çme
);

248 ià(
»adlšk
(
Çme
, 
bufãr
, 
MAXLEN
) < 0) {

249 
³¼Ü
("pid_uses_inode:„eadlinkƒrror");

252 ià(
ssÿnf
(
bufãr
, "pe:[%u]", &
‹mp_node
) == 1 &&

253 
‹mp_node
 =ğ
šode
) {

254 
şo£dœ
(
dœ
);

259 
şo£dœ
(
dœ
);

266 
	gSpPeWÜk”
::
g‘_šode_äom_fd
(
fd
) {

267 
¡©
 
s
;

268 ià(
f¡©
(
fd
, &
s
) != -1) {

269  
s
.
¡_šo
;

275 
	gSpPeWÜk”
::
g‘_pids_äom_fd
(
fd
, 
PidS‘
& 
pid_£t
) {

276 
	gpid
, 
	grv
, 
	gnum_found
 = 0;

277 
DIR
 *
	gdœ
;

278 *
	g•
;

279 
dœ’t
 *
	gde
;

281 ià((
	gdœ
 = 
İ’dœ
("/proc")) == 0) {

282 
¥_³¼Ü
("ERROR: cannot‡ccess /proc");

284 (
	gde
 = 
»addœ
(
dœ
)) != 0) {

285 ià(
isdig™
(
de
->
d_Çme
[0])) {

286 
pid
 = 
¡¹Ş
(
de
->
d_Çme
, &
•
, 10);

287 ià(
	g•
 =ğ0 || *
•
 !ğ0 || 
pid
 < 0) {

288 
¥_³¼Ü
("ERROR: sŒtŞ faed oÀ%s\n", 
de
->
d_Çme
);

290 ià(
pid_u£s_šode
(
pid
, 
g‘_šode_äom_fd
(
fd
))) {

291 
	gpid_£t
.
š£¹
(
pid
);

295 
şo£dœ
(
dœ
);

298 
SpChªÃl
* 
	gSpPeWÜk”
::
g‘_chªÃl
(
fd
) {

299 
šode
 = 
g‘_šode_äom_fd
(
fd
);

300 ià(
	gchªÃl_m­_
.
fšd
(
šode
è!ğ
chªÃl_m­_
.
’d
())

301  
chªÃl_m­_
[
šode
];

303 
SpChªÃl
* 
	gc
 = 
Ãw
 
PeChªÃl
;

304 
	gc
->
	gloÿl_pid
 = 
g‘pid
();

305 
PidS‘
 
	gpid_£t
;

306 
g‘_pids_äom_fd
(
fd
, 
pid_£t
);

307 
	gPidS‘
::
™”©Ü
 
i
 = 
pid_£t
.
begš
(); 
	gi
 !ğpid_£t.
’d
(); i++) {

308 ià(*
	gi
 !ğ
c
->
loÿl_pid
) {

309 
c
->
»mÙe_pid
 = *
i
;

313 
	gc
->
	gty³
 = 
SP_PIPE
;

315 #iâdeà
SP_RELEASE


316 
¥_debug
("PIPE CHANNEL - g‘‡…chªÃÈw™h inod%d fÜ fd %d", 
šode
, 
fd
);

318 
	gc
->
	gšode
 = 
šode
;

319 
	gchªÃl_m­_
[
šode
] = 
c
;

321  
	gc
;

326 
	gSpTıWÜk”
::
£t_¡¬t_Œacšg
(
yes_Ü_no
, 
pid_t
 
pid
) {

329 
	gSpTıWÜk”
::
¡¬t_Œacšg
() {

333 
boŞ
 
	gSpTıWÜk”
::
šjeù
(
SpChªÃl
*) {

338 
SpChªÃl
* 
	gSpTıWÜk”
::
g‘_chªÃl
(
fd
) {

343 
SpUdpWÜk”
::
£t_¡¬t_Œacšg
(
yes_Ü_no
, 
pid_t
 
pid
) {

346 
	gSpUdpWÜk”
::
¡¬t_Œacšg
() {

350 
boŞ
 
	gSpUdpWÜk”
::
šjeù
(
SpChªÃl
*) {

354 
SpChªÃl
* 
	gSpUdpWÜk”
::
g‘_chªÃl
(
fd
) {

355  
NULL
;

	@SpParser.C

1 
	~"SpIn¡rum’‹r.h
"

2 
	~"SpP¬£r.h
"

3 
	~"SpCÚ‹xt.h
"

4 
	~"SpAddrS·û.h
"

5 
	~"SpUts.h
"

6 
	~"SpPošt.h
"

7 
	~"SpPoštMak”.h
"

8 
	~"SpObjeù.h
"

10 
usšg
 
	gsb
::
Symb
;

11 
usšg
 
	gsb
::
SymbŞ
;

12 
usšg
 
	gsb
::
RegiÚ
;

14 
usšg
 
	g¥
::
SpP¬£r
;

15 
usšg
 
	g¥
::
SpAddrS·û
;

16 
usšg
 
	gsb
::
Add»ssLookup
;

18 
usšg
 
	g³
::
CodeObjeù
;

19 
usšg
 
	g³
::
CodeRegiÚ
;

20 
usšg
 
	g³
::
SymbCodeSourû
;

22 
usšg
 
	gš
::
ResuÉ
;

23 
usšg
 
	gš
::
Vis™Ü
;

24 
usšg
 
	gš
::
ImmedŸ‹
;

25 
usšg
 
	gš
::
Ex´essiÚ
;

26 
usšg
 
	gš
::
In¡ruùiÚ
;

27 
usšg
 
	gš
::
D”eã»nû
;

28 
usšg
 
	gš
::
Regi¡”AST
;

29 
usšg
 
	gš
::
Bš¬yFunùiÚ
;

30 
usšg
 
	gš
::
In¡ruùiÚDecod”
;

32 
usšg
 
	gph
::
Pošt
;

33 
usšg
 
	gph
::
P©chMgr
;

34 
usšg
 
	gph
::
AddrS·û
;

35 
usšg
 
	gph
::
P©chBlock
;

36 
usšg
 
	gph
::
PoštMak”
;

37 
usšg
 
	gph
::
P©chObjeù
;

38 
usšg
 
	gph
::
P©chMgrPŒ
;

39 
usšg
 
	gph
::
P©chFunùiÚ
;

41 
usšg
 
	gdt
::
Add»ss
;

43 
Çme¥aû
 
	g¥
 {

45 
SpCÚ‹xt
* 
g_cÚ‹xt
;

47 
	gSpP¬£r
::
SpP¬£r
()

48 : 
exe_obj_
(
NULL
), 
šjeùed_
(
çl£
),
¥_off£t_
(0) {

49 
š™_dynš¡_libs
();

52 
	gSpP¬£r
::~
SpP¬£r
() {

53 
CodeSourûs
::
™”©Ü
 
i
 = 
code_¤cs_
.
begš
();

54 
	gi
 !ğ
code_¤cs_
.
’d
(); i++) {

55 
SymbCodeSourû
* 
	gscs
 = 
¡©ic_ÿ¡
<SymbCodeSourû*>(*
i
);

56 
d–‘e
 
	gscs
;

58 
	gCodeObjeùs
::
™”©Ü
 
i
 = 
code_objs_
.
begš
();

59 
	gi
 !ğ
code_objs_
.
’d
(); i++)

60 
d–‘e
 *
	gi
;

63 
	gSpP¬£r
::
±r


64 
SpP¬£r
::
ü—‹
() {

65  
±r
(
Ãw
 
SpP¬£r
);

70 
Add»ss
 
	goff£ts
[100];

71 } 
	tIjLib
;

74 
boŞ


75 
	gSpP¬£r
::
is_dynš¡_lib
(
¡ršg
 
lib
) {

76 
i
 = 0; 
	gi
 < 
	gdynš¡_libs_
.
size
(); i++) {

77 ià(
	glib
.
fšd
(
dynš¡_libs_
[
i
]è!ğ
¡ršg
::
Åos
è 
Œue
;

79  
	gçl£
;

83 
	gSpP¬£r
::
š™_dynš¡_libs
() {

84 
dynš¡_libs_
.
push_back
("libpatchAPI.so");

85 
	gdynš¡_libs_
.
push_back
("libparseAPI.so");

86 
	gdynš¡_libs_
.
push_back
("libstackwalk.so");

87 
	gdynš¡_libs_
.
push_back
("libsymtabAPI.so");

88 
	gdynš¡_libs_
.
push_back
("libinstructionAPI.so");

89 
	gdynš¡_libs_
.
push_back
("libelf.so");

90 
	gdynš¡_libs_
.
push_back
("libdwarf.so");

91 
	gdynš¡_libs_
.
push_back
("libcommon.so");

95 
P©chMgrPŒ


96 
	gSpP¬£r
::
·r£
() {

97 ià(
mgr_
)  mgr_;

100 
Add»ssLookup
* 
	g®
 = Add»ssLookup::
ü—‹Add»ssLookup
(
g‘pid
());

101 
	g®
->
»äesh
();

102 
	g¡d
::
veùÜ
<
Symb
*> 
bs
;

103 
	g®
->
g‘AÎSymbs
(
bs
);

109 
	g¡d
::
veùÜ
<
Symb
*>::
™”©Ü
 
i
 = 
bs
.
begš
(); 
	gi
 !ğbs.
’d
(); i++) {

110 
Symb
* 
	gsym
 = *
i
;

111 ià(
	gsym
->
Çme
().
fšd
("libijag’t.so"è!ğ
¡ršg
::
Åos
) {

112 
šjeùed_
 = 
Œue
;

117 
	gshmid
;

118 
key_t
 
	gkey
 = 1985;

119 
IjLib
* 
	gshm
;

120 ià(
	gšjeùed_
) {

121 ià((
	gshmid
 = 
shmg‘
(
key
, (
IjLib
), 0666)) < 0) {

122 
³¼Ü
("shmget");

123 
ex™
(1);

125 ià((*)(
	gshm
 = (
IjLib
*)
shm©
(
shmid
, 
NULL
, 0)) == (*) -1) {

126 
³¼Ü
("shmat");

127 
ex™
(1);

135 
	gcur
 = 0;

136 
	g¡d
::
	tm­
<
	tAdd»ss
, 
	tboŞ
> 
	tLibLookup
;

137 
LibLookup
 
	glib_lookup
;

138 
	glib_lookup
[0] = 
Œue
;

139 ià(
	gšjeùed_
) {

140 
	gshm
->
	goff£ts
[
cur
] != -1) {

141 
lib_lookup
[
shm
->
off£ts
[
cur
]] = 
Œue
;

142 ++
	gcur
;

146 
P©chObjeùs
 
	g·tch_objs
;

147 
	g¡d
::
veùÜ
<
Symb
*>::
™”©Ü
 
i
 = 
bs
.
begš
(); 
	gi
 !ğbs.
’d
(); i++) {

148 
Symb
* 
	gsym
 = *
i
;

149 
Add»ss
 
	glßd_addr
 = 0;

150 
	g®
->
g‘LßdAdd»ss
(
sym
, 
lßd_addr
);

155 ià(
	gšjeùed_
) {

156 ià((
	glib_lookup
.
fšd
(
lßd_addr
è=ğ
lib_lookup
.
’d
()) &&

157 (
sym
->
Çme
().
fšd
(
¥_f’ame
(¥_f’ame(
g‘_ag’t_Çme
()))è=ğ
¡ršg
::
Åos
) &&

158 (
sym
->
Çme
().
fšd
("libag’t.so"è=ğ
¡ršg
::
Åos
)) {

159 #iâdeà
SP_RELEASE


160 
¥_debug
("SKIPED - sk…¬sšg %s", 
¥_f’ame
(
sym
->
Çme
().
c_¡r
()));

165 ià(
is_dynš¡_lib
(
sym
->
Çme
())) {

166 #iâdeà
SP_RELEASE


167 
¥_debug
("SKIPED - sk…¬sšg %s", 
¥_f’ame
(
sym
->
Çme
().
c_¡r
()));

174 
SymbCodeSourû
* 
	gscs
 = 
Ãw
 SymbCodeSourû(
sym
);

175 
	gcode_¤cs_
.
push_back
(
scs
);

176 
CodeObjeù
* 
	gco
 = 
Ãw
 CodeObjeù(
scs
);

177 
	gcode_objs_
.
push_back
(
co
);

178 
	gco
->
·r£
();

181 
P©chObjeù
* 
	g·tch_obj
 = 
Ãw
 
¥
::
SpObjeù
(
co
, 
lßd_addr
, 
NULL
, NULL,†ßd_addr?lßd_addr:
scs
->
lßdAdd»ss
());

183 
	g·tch_objs
.
push_back
(
·tch_obj
);

184 #iâdeà
SP_RELEASE


185 
¥_debug
("PARSED -…¬£d %s", 
¥_f’ame
(
sym
->
Çme
().
c_¡r
()));

187 ià(
	gsym
->
isExec
()) {

188 
	gexe_obj_
 = 
·tch_obj
;

189 #iâdeà
SP_RELEASE


190 
¥_debug
("EXE - % i ªƒxecubË", 
¥_f’ame
(
sym
->
Çme
().
c_¡r
()));

196 ià(!
	gexe_obj_
) {

197 
	gexe_obj_
 = 
·tch_objs
[0];

201 
SpAddrS·û
* 
	gas
 = SpAddrS·û::
ü—‹
(
exe_obj_
);

202 
	gph
::
In¡rum’‹r
* 
š¡
 = 
NULL
;

203 
	gš¡
 = 
¥
::
SpIn¡rum’‹r
::
ü—‹
(
as
);

205 
	g¥
::
SpPoštMak”
* 
pm
 = 
Ãw
 SpPointMaker;

206 
	gmgr_
 = 
P©chMgr
::
ü—‹
(
as
, 
š¡
, 
pm
);

207 
	gSpP¬£r
::
P©chObjeùs
::
™”©Ü
 
i
 = 
·tch_objs
.
begš
(); 
	gi
 !ğ·tch_objs.
’d
(); i++) {

208 ià(*
	gi
 !ğ
exe_obj_
) {

209 
as
->
lßdLib¿ry
(*
i
);

214 ià(
	gšjeùed_
) {

215 
shmùl
(
IJLIB_ID
, 
IPC_RMID
, 
NULL
);

216 
shmùl
(
IJMSG_ID
, 
IPC_RMID
, 
NULL
);

218  
	gmgr_
;

222 
P©chFunùiÚ
*

223 
	gSpP¬£r
::
fšdFunùiÚ
(
Add»ss
 
addr
) {

225 
AddrS·û
* 
as
 = 
mgr_
->as();

226 
	gAddrS·û
::
ObjM­
::
™”©Ü
 
ci
 = 
as
->
objM­
().
begš
(); 
	gci
 !ğas->objM­().
’d
(); ci++) {

227 
P©chObjeù
* 
	gobj
 = 
ci
->
£cÚd
;

228 
SymbCodeSourû
* 
	gcs
 = (SymbCodeSourû*)
obj
->
co
()->
cs
();

229 
Symb
* 
	gsym
 = 
cs
->
g‘SymbObjeù
();

230 
Add»ss
 
	glow”_bound
 = 
obj
->
codeBa£
();

231 ià(!
	glow”_bound
èlow”_bound = 
sym
->
g‘LßdOff£t
();

232 
Add»ss
 
	guµ”_bound
 = 
low”_bound
 + 
cs
->
Ëngth
();

234 ià(
	gaddr
 >ğ
low”_bound
 && 
addr
 <ğ
uµ”_bound
) {

235 
Add»ss
 
add»ss
 = 
addr
;

236 
	gsb
::
FunùiÚ
* 
f
;

237 ià(!
	gsym
->
g‘CÚššgFunùiÚ
(
add»ss
, 
f
)) {

238 
	gadd»ss
 -ğ
low”_bound
;

241 
	g¡d
::
veùÜ
<
CodeRegiÚ
*>::
cÚ¡_™”©Ü
 
ri
 = 
cs
->
»giÚs
().
begš
();

242 
	gri
 !ğ
cs
->
»giÚs
().
’d
();„i++) {

243 
	g¡d
::
£t
<
³
::
FunùiÚ
*> 
funcs
;

244 
	gobj
->
co
()->
fšdFuncs
(*
ri
, 
add»ss
, 
funcs
);

246 ià(
	gfuncs
.
size
() > 0) {

247 
P©chFunùiÚ
* 
	gpfunc
 = 
obj
->
g‘Func
(*
funcs
.
begš
());

248  
	gpfunc
;

254  
	gNULL
;

258 
	glibÇme
[512];

259 
	g”r
[512];

260 
	glßded
;

261 } 
	tIjMsg
;

265 
	gSpP¬£r
::
g‘_ag’t_Çme
() {

266 
shmid
;

267 
key_t
 
	gkey
 = 1986;

268 
IjMsg
* 
	gmsg_shm
;

269 ià((
	gshmid
 = 
shmg‘
(
key
, (
IjMsg
), 0666)) < 0) {

270 
¥_³¼Ü
("FATAL - Failedo get‡gent shared†ibrary‚ame");

272 ià((*)(
	gmsg_shm
 = (
IjMsg
*)
shm©
(
shmid
, 
NULL
, 0)) == (*) -1) {

273 
¥_³¼Ü
("FATAL - Failedo get‡gent†ibrary‚ame");

275  
	gmsg_shm
->
	glibÇme
;

279 
Add»ss


280 
	gSpP¬£r
::
g‘_func_addr
(
¡ršg
 
Çme
) {

281 
AddrS·û
* 
as
 = 
mgr_
->as();

282 
	gAddrS·û
::
ObjM­
::
™”©Ü
 
ci
 = 
as
->
objM­
().
begš
(); 
	gci
 !ğas->objM­().
’d
(); ci++) {

283 
P©chObjeù
* 
	gobj
 = 
ci
->
£cÚd
;

284 
CodeObjeù
* 
	gco
 = 
obj
->
co
();

285 
	gCodeObjeù
::
funşi¡
& 
®l
 = 
co
->
funcs
();

286 
	gCodeObjeù
::
funşi¡
::
™”©Ü
 
f™
 = 
®l
.
begš
(); 
	gf™
 !ğ®l.
’d
(); fit++) {

287 ià((*
	gf™
)->
Çme
().
com·»
(name) == 0) {

288 
Add»ss
 
addr
 = (*
f™
)->addr(è+ 
obj
->
codeBa£
();

289  
	gaddr
;

300 
P©chFunùiÚ
*

301 
	gSpP¬£r
::
fšdFunùiÚ
(
¡ršg
 
Çme
, 
boŞ
 
sk
) {

302 ià(
	g»®_func_m­_
.
fšd
(
Çme
è!ğ
»®_func_m­_
.
’d
()) {

303  
»®_func_m­_
[
Çme
];

306 
AddrS·û
* 
	gas
 = 
mgr_
->
as
();

307 
	gAddrS·û
::
ObjM­
::
™”©Ü
 
ci
 = 
as
->
objM­
().
begš
(); 
	gci
 !ğas->objM­().
’d
(); ci++) {

309 
P©chObjeù
* 
	gobj
 = 
ci
->
£cÚd
;

310 
CodeObjeù
* 
	gco
 = 
obj
->
co
();

311 
	gCodeObjeù
::
funşi¡
& 
®l
 = 
co
->
funcs
();

312 
SymbCodeSourû
* 
	gcs
 = (SymbCodeSourû*)
obj
->
co
()->
cs
();

313 
Symb
* 
	gsym
 = 
cs
->
g‘SymbObjeù
();

314 ià(
	gsk
 && 
	gg_cÚ‹xt
->
is_w–l_known_lib
(
¥_f’ame
(
sym
->
Çme
().
c_¡r
()))) {

318 
	gCodeObjeù
::
funşi¡
::
™”©Ü
 
f™
 = 
®l
.
begš
(); 
	gf™
 !ğ®l.
’d
(); fit++) {

319 ià((*
	gf™
)->
Çme
().
com·»
(name) == 0) {

320 
RegiÚ
* 
»giÚ
 = 
sym
->
fšdEnşosšgRegiÚ
((*
f™
)->
addr
());

321 ià(
	g»giÚ
 &&„egiÚ->
g‘RegiÚName
().
com·»
(".plt") == 0) {

324 
P©chFunùiÚ
* 
	gfound
 = 
obj
->
g‘Func
(*
f™
);

325 
	g»®_func_m­_
[
Çme
] = 
found
;

326  
	gfound
;

330  
	gNULL
;

334 
¡ršg


335 
	gSpP¬£r
::
dump_š¢
(* 
addr
, 
size_t
 
size
) {

337 
Add»ss
 
	gba£
 = (Add»ss)
addr
;

338 
SymbCodeSourû
* 
	gcs
 = (SymbCodeSourû*)
mgr_
->
as
()->
execubË
()->
co
()->
cs
();

339 
¡ršg
 
	gs
;

340 
	gbuf
[256];

341 
In¡ruùiÚDecod”
 
deco
(
addr
,

342 
size
,

343 
cs
->
g‘Arch
());

344 
	gIn¡ruùiÚ
::
PŒ
 
š¢
 = 
deco
.
decode
();

345 
	gš¢
) {

346 
¥rštf
(
buf
, " %lx(%2d by‹s): %-25 | ", 
ba£
, 
š¢
->
size
(), in¢->
fÜm©
(ba£).
c_¡r
());

347 * 
	g¿w
 = (*)
š¢
->
±r
();

348 
	gi
 = 0; i < 
	gš¢
->
size
(); i++)

349 
¥rštf
(
buf
, "%s%0.2x ", buf, 0xff&
¿w
[
i
]);

350 
¥rštf
(
buf
, "%s\n", buf);

351 
	gs
 +ğ
buf
;

352 
	gba£
 +ğ
š¢
->
size
();

353 
	gš¢
 = 
deco
.
decode
();

355  
	gs
;

358 şas 
	cSpVis™Ü
 : 
public
 
Vis™Ü
 {

359 
public
:

360 
SpVis™Ü
(
¥
::
SpPošt
* 
±
)

361 : 
Vis™Ü
(), 
ÿÎ_addr_
(0), 
±_
(
±
), 
u£_pc_
(
çl£
) { }

362 
vœtu®
 
vis™
(
Regi¡”AST
* 
r
) {

363 ià(
	gSpP¬£r
::
is_pc
(
r
->
g‘ID
())) {

364 
u£_pc_
 = 
Œue
;

365 
	gÿÎ_addr_
 = 
±_
->
block
()->
’d
();

368 
Add»ss
 
	grv®
 = 
±_
->
¢
()->
g‘_§ved_»g
(
r
->
g‘ID
());

369 
	gÿÎ_addr_
 = 
rv®
;

371 
	g¡ack_
.
push
(
ÿÎ_addr_
);

373 
vœtu®
 
vis™
(
Bš¬yFunùiÚ
* 
b
) {

374 
Add»ss
 
	gi1
 = 
¡ack_
.
tİ
();

375 
	g¡ack_
.
pİ
();

376 
Add»ss
 
	gi2
 = 
¡ack_
.
tİ
();

377 
	g¡ack_
.
pİ
();

379 ià(
	gb
->
isAdd
()) {

380 
	gÿÎ_addr_
 = 
i1
 + 
i2
;

381 } ià(
	gb
->
isMuÉly
()) {

382 
	gÿÎ_addr_
 = 
i1
 * 
i2
;

384 
as£¹
(0);

387 
	g¡ack_
.
push
(
ÿÎ_addr_
);

389 
vœtu®
 
vis™
(
ImmedŸ‹
* 
i
) {

390 
ResuÉ
 
	g»s
 = 
i
->
ev®
();

391 
	g»s
.
size
()) {

393 
ÿÎ_addr_
 =
»s
.
v®
.
u8v®
;

397 
ÿÎ_addr_
 =
»s
.
v®
.
u16v®
;

401 
ÿÎ_addr_
 =
»s
.
v®
.
u32v®
;

405 
ÿÎ_addr_
 =
»s
.
v®
.
u64v®
;

409 
	g¡ack_
.
push
(
ÿÎ_addr_
);

411 
vœtu®
 
vis™
(
D”eã»nû
* 
d
) {

412 
Add»ss
* 
	gaddr
 = (Add»ss*)
¡ack_
.
tİ
();

413 
	g¡ack_
.
pİ
();

414 
	gÿÎ_addr_
 = *
addr
;

415 
	g¡ack_
.
push
(
ÿÎ_addr_
);

418 
Add»ss
 
ÿÎ_addr
() const {

419  
	gÿÎ_addr_
;

421 
boŞ
 
u£_pc
() const {

422  
	gu£_pc_
;

424 
	g´iv©e
:

425 
¡d
::
¡ack
<
Add»ss
> 
¡ack_
;

426 
Add»ss
 
	gÿÎ_addr_
;

427 
	g¥
::
SpPošt
* 
±_
;

428 
boŞ
 
	gu£_pc_
;

432 
P©chFunùiÚ
*

433 
	gSpP¬£r
::
	$ÿÎ“
(
Pošt
* 
±
, 
boŞ
 
·r£_šdœeù
) {

437 
¥
::
SpPošt
* 
¥t
 = 
¡©ic_ÿ¡
<¥::SpPošt*>(
±
);

438 ià(
¥t
->
	`ÿÎ“
())  spt->callee();

441 
P©chFunùiÚ
* 
f
 = 
±
->
	`g‘C®Ëe
();

442 ià(
f
) {

443 
¥t
->
	`£t_ÿÎ“
(
f
);

444  
f
;

446 ià(
¥t
->
	`ÿÎ“
()) {

447  
¥t
->
	`ÿÎ“
();

451 ià(
·r£_šdœeù
) {

453 
P©chBlock
* 
blk
 = 
±
->
	`block
();

454 
In¡ruùiÚ
::
PŒ
 
š¢
 = 
¥t
->
	`¢
()->
	`g‘_Üig_ÿÎ_š¢
();

455 
Ex´essiÚ
::
PŒ
 
Œg
 = 
š¢
->
	`g‘CÚŒŞFlowT¬g‘
();

456 
Add»ss
 
ÿÎ_addr
 = 0;

457 ià(
Œg
) {

458 
SpVis™Ü
 
	`vis™Ü
(
¥t
);

459 
Œg
->
	`­¶y
(&
vis™Ü
);

460 
ÿÎ_addr
 = 
vis™Ü
.
	`ÿÎ_addr
();

461 
f
 = 
	`fšdFunùiÚ
(
ÿÎ_addr
);

462 ià(
f
) {

463 
¥t
->
	`£t_ÿÎ“
(
f
);

464  
f
;

468 
	`¥_´št
("CANNOT RESOLVE ADDR %lx, SKIP fÜ blob %lx", 
ÿÎ_addr
, 
¥t
->
	`¢
()->
	`buf
());

470 *
d
 = (*)(
¥t
->
	`¢
()->
	`g‘_§ved_»g
(
¼
->
	`g‘ID
()è+ 
di¥
);

471 
	`¥_´št
("RR: %s, [%lx+%lx]=>%lx", 
¼
->
	`g‘ID
().
	`Çme
().
	`c_¡r
(), 
¥t
->
	`¢
()->
	`g‘_§ved_»g
Ôr->g‘ID()), 
di¥
, *
d
);

472 
	`¥_´št
("ORIG CALL DUMP INSN (%d by‹s)- {", 
¥t
->
	`¢
()->
	`g‘_Üig_ÿÎ_š¢
()->
	`size
());

473 
	`¥_´št
("%s", 
	`dump_š¢
((*)
¥t
->
	`¢
()->
	`g‘_Üig_ÿÎ_š¢
()->
	`±r
(), s±->¢()->g‘_Üig_ÿÎ_š¢()->
	`size
()).
	`c_¡r
());

474 
	`¥_´št
("DUMP INSN - }");

476 
	`¥_´št
("DUMP INSN (%d by‹s)- {", 
¥t
->
	`¢
()->
	`size
());

477 
	`¥_´št
("%s", 
	`dump_š¢
((*)
¥t
->
	`¢
()->
	`buf
(), s±->¢()->
	`size
()).
	`c_¡r
());

478 
	`¥_´št
("DUMP INSN - }");

480  
NULL
;

483  
NULL
;

484 
	}
}

	@SpPayload.C

1 
	~"SpPaylßd.h
"

2 
	~"SpCÚ‹xt.h
"

3 
	~"SpPošt.h
"

4 
	~"SpUts.h
"

5 
	~"SpIPC.h
"

7 
usšg
 
	gph
::
Pošt
;

8 
usšg
 
	gph
::
Scİe
;

9 
usšg
 
	gph
::
P©chMgr
;

10 
usšg
 
	gph
::
P©chEdge
;

11 
usšg
 
	gph
::
P©chBlock
;

12 
usšg
 
	gph
::
P©chMgrPŒ
;

13 
usšg
 
	gph
::
P©chObjeù
;

14 
usšg
 
	gph
::
P©chFunùiÚ
;

16 
usšg
 
	g¥
::
SpPošt
;

17 
usšg
 
	g¥
::
SpChªÃl
;

18 
usšg
 
	g¥
::
Argum’tHªdË
;

19 
usšg
 
	g¥
::
SpIpcMgr
;

21 
Çme¥aû
 
	g¥
 {

22 
SpCÚ‹xt
* 
g_cÚ‹xt
;

27 
w¿µ”_befÜe
(
SpPošt
* 
±
, 
¥
::
PaylßdFunc_t
 
befÜe
) {

28 ià(!
SpIpcMgr
::
´e_befÜe
(
±
)) ;

29 
befÜe
(
±
);

34 
w¿µ”_aá”
(
SpPošt
* 
±
, 
¥
::
PaylßdFunc_t
 
aá”
) {

35 ià(!
SpIpcMgr
::
´e_aá”
(
±
)) ;

36 
aá”
(
±
);

41 
	$deçuÉ_befÜe
(
Pošt
* 
±
) {

42 
P©chFunùiÚ
* 
f
 = 
¥
::
	`ÿÎ“
(
±
);

43 ià(!
f
) ;

45 
¡ršg
 
ÿÎ“_Çme
 = 
f
->
	`Çme
();

46 
	`¥_´št
("EÁ” %s", 
ÿÎ“_Çme
.
	`c_¡r
());

48 
¥
::
	`´İ–
(
±
);

49 
	}
}

52 
	$deçuÉ_aá”
(
Pošt
* 
±
) {

53 
P©chFunùiÚ
* 
f
 = 
¥
::
	`ÿÎ“
(
±
);

54 ià(!
f
) ;

56 
¡ršg
 
ÿÎ“_Çme
 = 
f
->
	`Çme
();

57 
	`¥_´št
("L—v%s", 
ÿÎ“_Çme
.
	`c_¡r
());

58 
	}
}

61 
Çme¥aû
 
	g¥
 {

64 
P©chFunùiÚ
*

65 
ÿÎ“
(
ph
::
Pošt
* 
±
) {

66  
g_cÚ‹xt
->
ÿÎ“
(
±
);

71 
pİ_¬gum’t
(
ph
::
Pošt
* 
±
, 
Argum’tHªdË
* 
h
, 
size_t
 
size
) {

72  
	g¡©ic_ÿ¡
<
	gSpPošt
*>(
	g±
)->
¢
()->
pİ_¬gum’t
(
h
, 
size
);

77 
´İ–
(
ph
::
Pošt
* 
±
) {

80 
SpPošt
* 
¥t
 = 
¡©ic_ÿ¡
<
¥
::SpPošt*>(
±
);

81 ià(
	g¥t
->
´İag©ed
()) {

85 
P©chFunùiÚ
* 
	gf
 = 
ÿÎ“
(
±
);

86 ià(!
	gf
) ;

88 
	g¥
::
SpPrİ–Ër
::
±r
 
p
 = 
g_cÚ‹xt
->
š™_´İ–Ër
();

89 
	gp
->
go
(
f
, 
g_cÚ‹xt
, g_cÚ‹xt->
š™_befÜe
(), g_cÚ‹xt->
š™_aá”
(), 
±
);

90 
	g¥t
->
£t_´İag©ed
(
Œue
);

93 
	gArgum’tHªdË
::
Argum’tHªdË
(è: 
off£t
(0), 
num
(0) {}

96 
	gArgum’tHªdË
::
š£¹_buf
(
size_t
 
s
) {

97 * 
b
 = 
Ãw
 [
s
];

98 
	gbufs
.
push_back
(
b
);

99  
	gb
;

102 
	gArgum’tHªdË
::~
Argum’tHªdË
() {

103 
i
 = 0; 
	gi
 < 
	gbufs
.
size
(); i++è
d–‘e
 bufs[i];

107 
»tv®
(
¥
::
SpPošt
* 
±
) {

108  
±
->
¢
()->
g‘_»t_v®
();

111 
boŞ


112 
is_c
(
fd
) {

113 
	g¥
::
SpIpcMgr
* 
c_mgr
 = 
g_cÚ‹xt
->ipc_mgr();

114  
	gc_mgr
->
is_c
(
fd
);

118 
¡¬t_Œacšg
() {

119 
	g¥
::
SpIpcMgr
* 
c_mgr
 = 
g_cÚ‹xt
->ipc_mgr();

120  
	gc_mgr
->
¡¬t_Œacšg
();

	@SpPointMaker.h

1 #iâdeà
_SPPOINTMAKER_H_


2 
	#_SPPOINTMAKER_H_


	)

4 
	~"SpAg’tCommÚ.h
"

7 
Çme¥aû
 
	g¥
 {

8 şas 
	cSpPoštMak”
 : 
public
 
ph
::
PoštMak”
 {

9 
´Ùeùed
:

11 
vœtu®
 
ph
::
Pošt
*

12 
mkFuncPošt
(
ph
::
Pošt
::
Ty³
 
t
,

13 
ph
::
P©chMgrPŒ
 
m
,

14 
ph
::
P©chFunùiÚ
* 
f
) {

15  
Ãw
 
SpPošt
(
t
, 
m
, 
f
);

18 
vœtu®
 
	gph
::
Pošt
*

19 
mkFuncS™ePošt
(
ph
::
Pošt
::
Ty³
 
t
,

20 
ph
::
P©chMgrPŒ
 
m
,

21 
ph
::
P©chFunùiÚ
* 
f
,

22 
ph
::
P©chBlock
* 
b
) {

23  
Ãw
 
SpPošt
(
t
, 
m
, 
f
, 
b
);

26 
vœtu®
 
	gph
::
Pošt
*

27 
mkBlockPošt
(
ph
::
Pošt
::
Ty³
 
t
,

28 
ph
::
P©chMgrPŒ
 
m
,

29 
ph
::
P©chBlock
* 
b
,

30 
ph
::
P©chFunùiÚ
* 
f
) {

31  
Ãw
 
SpPošt
(
t
, 
m
, 
b
, 
f
);

33 
vœtu®
 
	gph
::
Pošt
*

34 
mkIn¢Pošt
(
ph
::
Pošt
::
Ty³
 
t
,

35 
ph
::
P©chMgrPŒ
 
m
,

36 
ph
::
P©chBlock
* 
b
,

37 
Dynš¡
::
Add»ss
 
a
,

38 
š
::
In¡ruùiÚ
::
PŒ
 
i
,

39 
ph
::
P©chFunùiÚ
 *
f
) {

40  
Ãw
 
SpPošt
(
t
, 
m
, 
b
, 
a
, 
i
, 
f
);

42 
vœtu®
 
	gph
::
Pošt
*

43 
mkEdgePošt
(
ph
::
Pošt
::
Ty³
 
t
,

44 
ph
::
P©chMgrPŒ
 
m
,

45 
ph
::
P©chEdge
* 
e
,

46 
ph
::
P©chFunùiÚ
* 
f
) {

47  
Ãw
 
SpPošt
(
t
, 
m
, 
e
, 
f
);

	@SpPropeller.C

1 
	~"SpPrİ–Ër.h
"

2 
	~"SpCÚ‹xt.h
"

3 
	~"SpSn³t.h
"

4 
	~"SpUts.h
"

6 
usšg
 
	g¥
::
SpCÚ‹xt
;

7 
usšg
 
	g¥
::
SpPrİ–Ër
;

9 
usšg
 
	gph
::
Pošt
;

10 
usšg
 
	gph
::
Scİe
;

11 
usšg
 
	gph
::
P©ch”
;

12 
usšg
 
	gph
::
Sn³t
;

13 
usšg
 
	gph
::
P©chMgr
;

14 
usšg
 
	gph
::
P©chBlock
;

15 
usšg
 
	gph
::
P©chMgrPŒ
;

16 
usšg
 
	gph
::
P©chFunùiÚ
;

17 
usšg
 
	gph
::
PushBackCommªd
;

19 
Çme¥aû
 
	g¥
 {

21 
	gSpPrİ–Ër
::
SpPrİ–Ër
() {

24 
SpPrİ–Ër
::
±r


25 
SpPrİ–Ër
::
ü—‹
() {

26  
±r
(
Ãw
 
SpPrİ–Ër
);

34 
boŞ


35 
	gSpPrİ–Ër
::
go
(
P©chFunùiÚ
* 
func
, 
SpCÚ‹xt
* 
cÚ‹xt
, 
PaylßdFunc
 
befÜe
,

36 
PaylßdFunc
 
aá”
, 
Pošt
* 
±
) {

37 #iâdeà
SP_RELEASE


38 
¥_debug
("START PROPELLING -…rİ–ØÿÎ“ oàfunùiÚ %s", 
func
->
Çme
().
c_¡r
());

41 
Pošts
 
	g±s
;

42 
P©chMgrPŒ
 
	gmgr
 = 
cÚ‹xt
->
mgr
();

43 
P©chFunùiÚ
* 
	gcur_func
 = 
NULL
;

44 ià(
	g±
) {

45 
	gcur_func
 = 
func
;

47 
	gcur_func
 = 
cÚ‹xt
->
·r£r
()->
fšdFunùiÚ
(
func
->
Çme
());

49 
Ãxt_pošts
(
cur_func
, 
mgr
, 
±s
);

52 
	gph
::
P©ch”
 
·tch”
(
mgr
);

53 
	gi
 = 0; i < 
	g±s
.
size
(); i++) {

54 
Pošt
* 
	g±
 = 
±s
[
i
];

59 
P©chFunùiÚ
* 
	gÿÎ“
 = 
cÚ‹xt
->
·r£r
()->
ÿÎ“
(
±
);

60 #iâdeà
SP_RELEASE


61 ià(
	gÿÎ“
) {

62 
¥_debug
("POINT - instrumenting direct call‡t %lxo function %s",

63 
±
->
block
()->
Ï¡
(), 
ÿÎ“
->
Çme
().
c_¡r
());

65 
¥_debug
("POINT - in¡rum’tšg indœeù c®È© %lx", 
±
->
block
()->
Ï¡
());

68 
	gSpSn³t
::
±r
 
¥_¢
 = 
SpSn³t
::
ü—‹
(
ÿÎ“
, 
±
, 
cÚ‹xt
, 
befÜe
, 
aá”
);

69 
	gSn³t
<
	gSpSn³t
::
±r
>::
PŒ
 
¢
 = 
Sn³t
<
SpSn³t
::±r>::
ü—‹
(
¥_¢
);

70 
	g·tch”
.
add
(
PushBackCommªd
::
ü—‹
(
±
, 
¢
));

72 
	g·tch”
.
comm™
();

73 #iâdeà
SP_RELEASE


74 
¥_debug
("FINISH PROPELLING - %d c®Ëe oàfunùiÚ % ¬š¡rum’‹d", 
±s
.
size
(), 
func
->
Çme
().
c_¡r
());

76  
	gŒue
;

81 
	gSpPrİ–Ër
::
Ãxt_pošts
(
P©chFunùiÚ
* 
cur_func
, 
P©chMgrPŒ
 
mgr
, 
Pošts
& 
±s
) {

82 
Scİe
 
scİe
(
cur_func
);

83 
	gmgr
->
fšdPošts
(
scİe
, 
Pošt
::
P»C®l
, 
back_š£¹”
(
±s
));

	@SpSnippet.C

1 
	~"SpEv’t.h
"

2 
	~"SpP¬£r.h
"

3 
	~"SpCÚ‹xt.h
"

4 
	~"SpSn³t.h
"

5 
	~"SpPošt.h
"

6 
	~"SpUts.h
"

7 
	~"SpObjeù.h
"

9 
usšg
 
	gph
::
Pošt
;

10 
usšg
 
	gdt
::
Add»ss
;

11 
usšg
 
	gph
::
P©chBlock
;

12 
usšg
 
	gph
::
P©chFunùiÚ
;

14 
Çme¥aû
 
	g¥
 {

17 
	gSpSn³t
::
SpSn³t
(
P©chFunùiÚ
* 
f
,

18 
Pošt
* 
±
,

19 
SpCÚ‹xt
* 
c
,

20 
PaylßdFunc
 
befÜe
,

21 
PaylßdFunc
 
aá”
)

22 : 
func_
(
f
), 
pošt_
(
±
), 
cÚ‹xt_
(
c
), 
befÜe_
(
befÜe
), 
aá”_
(
aá”
),

23 
blob_size_
(0), 
¥ršg_size_
(0), 
¥ršg_blk_
(
NULL
), 
»®loc_
(
çl£
) {

25 
	gph
::
P©chMgrPŒ
 
mgr
 = 
c
->mgr();

26 
	gph
::
AddrS·û
* 
as
 = 
mgr
->as();

31 
	gblob_
 = (*)
as
->
m®loc
(
±
->
obj
(), 1024,

32 
¡©ic_ÿ¡
<
¥
::
SpObjeù
*>(
±
->
obj
())->
lßd_addr
());

35 
	gSpSn³t
::~
SpSn³t
() {

36 ià(!
»®loc_
è
ä“
(
blob_
);

39 * 
	gSpSn³t
::
»®loc
() {

40 * 
buf
 = 
NULL
;

41 
	g»®loc_
 = 
Œue
;

43  
	gbuf
;

58 
	gSpSn³t
::
blob
(
Add»ss
 
»t_addr
, 
boŞ
 
»loc
, boŞ 
¥ršg
) {

59 
as£¹
(
cÚ‹xt_
);

60 
	g»t_addr_
 = 
»t_addr
;

63 ià(
	gblob_size_
 > 0) {

64  
	gblob_
;

68 ià(
	g»loc
) {

69 
P©chBlock
* 
	gblk
 = 
NULL
;

70 
	gblk
 = 
pošt_
->
block
();

71 
	gblob_size_
 +ğ
»loc_block
(
blk
, 
blob_
, 
blob_size_
);

76 
	gblob_size_
 +ğ
em™_§ve
(
blob_
, 
blob_size_
, 
»loc
);

79 
	g·¿m_func
 = 0;

80 
	gÿÎed_func
 = ()
befÜe_
;

81 ià(
	gcÚ‹xt_
->
®low_c
()) {

82 
	g·¿m_func
 = ()
befÜe_
;

83 
	gÿÎed_func
 = ()
cÚ‹xt_
->
w¿µ”_befÜe
();

85 
	gblob_size_
 +ğ
em™_·ss_·¿m
(()
pošt_
, 
·¿m_func
, 
blob_
, 
blob_size_
);

86 
	gblob_size_
 +ğ
em™_ÿÎ_abs
(
ÿÎed_func
, 
blob_
, 
blob_size_
, 
Œue
);

89 
	gblob_size_
 +ğ
em™_»¡Üe
(
blob_
, 
blob_size_
, 
»loc
);

97 ià(!
	g»t_addr
 && 
	gfunc_
) {

99 
	gblob_size_
 +ğ
em™_jump_abs
(()
func_
->
addr
(), 
blob_
, 
blob_size_
);

100 
	gEXIT
;

101 } ià(
	g»t_addr
 && 
	gfunc_
) {

103 
	gblob_size_
 +ğ
em™_ÿÎ_abs
(()
func_
->
addr
(), 
blob_
, 
blob_size_
, 
çl£
);

106 
	gblob_size_
 +ğ
em™_ÿÎ_Üig
(()
pošt_
->
block
()->
Ï¡
(),

107 
Üig_ÿÎ_š¢_
->
size
(), 
blob_
, 
blob_size_
);

110 ià(
	gcÚ‹xt_
->
®low_c
(è|| 
	gaá”_
) {

112 
	gblob_size_
 +ğ
em™_§ve
(
blob_
, 
blob_size_
, 
»loc
);

115 
	g·¿m_func
 = 0;

116 
	gÿÎed_func
 = ()
aá”_
;

117 ià(
	gcÚ‹xt_
->
®low_c
()) {

118 
	g·¿m_func
 = ()
aá”_
;

119 
	gÿÎed_func
 = ()
cÚ‹xt_
->
w¿µ”_aá”
();

121 
	gblob_size_
 +ğ
em™_·ss_·¿m
(()
pošt_
, 
·¿m_func
, 
blob_
, 
blob_size_
);

122 
	gblob_size_
 +ğ
em™_ÿÎ_abs
(
ÿÎed_func
, 
blob_
, 
blob_size_
, 
Œue
);

125 
	gblob_size_
 +ğ
em™_»¡Üe
(
blob_
, 
blob_size_
, 
»loc
);

129 
	gblob_size_
 +ğ
em™_jump_abs
(
»t_addr
, 
blob_
, 
blob_size_
);

131 
	gEXIT
:

133 #iâdeà
SP_RELEASE


134 
¥_debug
("DUMP PATCH AREA (%d by‹sèfÜ…ošˆ%lx - {", 
blob_size_
, 
pošt_
->
block
()->
Ï¡
());

135 
¥_debug
("%s", 
cÚ‹xt_
->
·r£r
()->
dump_š¢
((*)
blob_
, 
blob_size_
).
c_¡r
());

136 
¥_debug
("}");

139  
	gblob_
;

143 
size_t


144 
	gSpSn³t
::
»loc_block
(
P©chBlock
* 
blk
, * 
buf
, 
size_t
 
off£t
) {

145 * 
	gp
 = 
buf
 + 
off£t
;

146 
Add»ss
 
	gÿÎ_addr
 = 
blk
->
Ï¡
();

148 
	gP©chBlock
::
In¢s
 
š¢s
;

149 
	gblk
->
g‘In¢s
(
š¢s
);

150 
	gP©chBlock
::
In¢s
::
™”©Ü
 
i
 = 
š¢s
.
begš
(); 
	gi
 !ğš¢s.
’d
(); i++) {

151 
usšg
 
Çme¥aû
 
	gDynš¡
::
In¡ruùiÚAPI
;

153 
Add»ss
 
	ga
 = 
i
->
fœ¡
;

154 
	gIn¡ruùiÚ
::
PŒ
 
š¢
 = 
i
->
£cÚd
;

155 
	gp
 +ğ
»loc_š¢
(
a
, 
š¢
, 
ÿÎ_addr
, 
p
);

158  (
	gp
 - (
	gbuf
 + 
	goff£t
));

173 
P©chBlock
*

174 
	gSpSn³t
::
¥ršg_blk
() {

175 ià(
¥ršg_blk_
)  spring_blk_;

177 
size_t
 
	gmš_¥ršgblk_size
 = 
jump_abs_size
() * 2;

178 
P©chBlock
* 
	gÿÎblk
 = 
pošt_
->
block
();

181 
	gaá”_jmp
 = 
ÿÎblk
->
¡¬t
() + 2;

182 
boŞ
 
	gdÚe
 = 
çl£
;

185 
P©chBlock
* 
	g¥ršgblk
 = 
NULL
;

186 
	gph
::
P©chObjeù
* 
obj
 = 
ÿÎblk
->obj();

188 
usšg
 
Çme¥aû
 
	gDynš¡
::
P¬£API
;

189 
CodeObjeù
* 
	gco
 = 
obj
->
co
();

190 
CodeSourû
* 
	gcs
 = 
co
->
cs
();

191 
	g¡d
::
veùÜ
<
CodeRegiÚ
*> 
»giÚs
 = 
cs
->regions();

194 
	guµ”
 = 127 + 
aá”_jmp
 - 
jump_abs_size
();

195 
	glow”
 = -128 + 
aá”_jmp
 - 
jump_abs_size
();

197 
	gi
 = 0; i < 
	g»giÚs
.
size
(); i++) {

198 
CodeRegiÚ
* 
	gü
 = 
»giÚs
[
i
];

199 ià((
	glow”
 <ğ
ü
->
low
(è&& cr->low(è< 
uµ”
) ||

200 (
ü
->
low
(è<ğ
low”
 && 
uµ”
 < cr->
high
()) ||

201 (
low”
 <ğ
ü
->
high
(è&& cr->high(è< 
uµ”
)

204 
Add»ss
 
¥ª_addr
 = 
low”
;

206 
	g£t
<
	gBlock
*> 
	gblks
;

207 
	gco
->
fšdBlocks
(
ü
, 
¥ª_addr
, 
blks
);

208 ià(
	gblks
.
size
() == 0) {

209 ++
¥ª_addr
;

212 
Block
* 
	gb
;

213 
	g£t
<
	gBlock
*>::
™”©Ü
 
bi
 = 
blks
.
begš
(); 
	gbi
 !ğblks.
’d
(); bi++) {

214 
	gb
 = *
bi
;

216 
size_t
 
	g»l
 = 
b
->
¡¬t
(è+ 
jump_abs_size
(è- 
aá”_jmp
;

217 ià(!
	g¥
::
is_di¥8
(
»l
)) {

218 
¥ª_addr
 = 
b
->
’d
();

221 
size_t
 
	gs
 = 
b
->
Ï¡In¢Addr
(è- b->
¡¬t
();

222 ià(
	gs
 < 
	gmš_¥ršgblk_size
) {

223 
	g¥ª_addr
 = 
b
->
’d
();

226 
P©chBlock
* 
	gpb
 = 
obj
->
g‘Block
(
b
);

229 ià(
	gpb
->
cÚšsC®l
()) {

230 
	g¥ª_addr
 = 
b
->
’d
();

235 ià(
	gcÚ‹xt_
->
š_¥ršg_£t
(
pb
)) {

236 
	g¥ª_addr
 = 
b
->
’d
();

239 
	g¥ršgblk
 = 
pb
;

240 
	gcÚ‹xt_
->
add_¥ršg
(
pb
);

241 
	gdÚe
 = 
Œue
;

243 } 
	g¥ª_addr
 < 
	guµ”
);

244 ià(
	gdÚe
) ;

248 
	g¥ršg_blk_
 = 
¥ršgblk
;

249  
	g¥ršgblk
;

254 
	gSpSn³t
::
¥ršg
(
Add»ss
 
»t_addr
) {

255 
ph
::
P©chMgrPŒ
 
mgr
 = 
cÚ‹xt_
->mgr();

256 
	gph
::
AddrS·û
* 
as
 = 
mgr
->as();

257 
	g¥ršg_
 = (*)
as
->
m®loc
(
pošt_
->
obj
(), 1024, 
¡©ic_ÿ¡
<
¥
::
SpObjeù
*>Õošt_->obj())->
lßd_addr
());

258 
	g¥ršg_size_
 = 0;

261 
	g¥ršg_size_
 +ğ
»loc_block
(
¥ršg_blk_
, 
¥ršg_
, 0);

264 
	g¥ršg_size_
 +ğ
em™_jump_abs
(
»t_addr
, 
¥ršg_
, 
¥ršg_size_
);

266 #iâdeà
SP_RELEASE


267 
¥_debug
("DUMP RELOC SPRING INSNS (%d by‹sèfÜ…ošˆ%s- {", 
¥ršg_size_
, 
pošt_
->
block
()->
Ï¡
());

268 
¥_debug
("%s", 
cÚ‹xt_
->
·r£r
()->
dump_š¢
((*)
¥ršg_
, 
¥ršg_size_
).
c_¡r
());

269 
¥_debug
("}");

271  
	g¥ršg_
;

	@SpUtils.C

1 
	~"SpUts.h
"

3 
Çme¥aû
 
	g¥
 {

6 
	ti64
;

7 
	sCP”fCouÁ”Rec
 {

8 
i64
 
	g_äeq
;

9 
i64
 
	g_şocks
;

10 
i64
 
	g_¡¬t
;

11 } 
	tCP”fCouÁ”
;

13 
S‘upTim”
();

14 
S¹Tim”
();

15 
StİTim”
();

16 
Re£tTim”
();

17 
G‘Tim”
();

18 
PrštTime
(*, );

20 
CP”fCouÁ”
 
	ga
[10];

22 
	gš¡rum’‹r_tim”
 = 0;

23 
	gš¡®l_tim”
 = 0;

24 
	g´İ–Ër_tim”
 = 0;

25 
	gÃxt_pošt_tim”
 = 0;

26 
	gÿÎ“_tim”
 = 0;

27 
	gfšdfunc_tim”
 = 0;

28 
	g·ylßd_tim”
 = 0;

31 
š¡rum’‹r_¡¬t
() {

32 
S‘upTim”
(0);

33 
S¹Tim”
(0);

37 
š¡rum’‹r_’d
() {

38 
StİTim”
(0);

39 
	gš¡rum’‹r_tim”
 +ğ
a
[0].
_şocks
;

43 
š¡®l_¡¬t
() {

44 
S‘upTim”
(1);

45 
S¹Tim”
(1);

49 
š¡®l_’d
() {

50 
StİTim”
(1);

51 
	gš¡®l_tim”
 +ğ
a
[1].
_şocks
;

55 
´İ–Ër_¡¬t
() {

56 
S‘upTim”
(2);

57 
S¹Tim”
(2);

61 
´İ–Ër_’d
() {

62 
StİTim”
(2);

63 
	g´İ–Ër_tim”
 +ğ
a
[2].
_şocks
;

67 
Ãxt_pošt_¡¬t
() {

68 
S‘upTim”
(3);

69 
S¹Tim”
(3);

73 
Ãxt_pošt_’d
() {

74 
StİTim”
(3);

75 
	gÃxt_pošt_tim”
 +ğ
a
[3].
_şocks
;

79 
ÿÎ“_¡¬t
() {

80 
S‘upTim”
(4);

81 
S¹Tim”
(4);

85 
ÿÎ“_’d
() {

86 
StİTim”
(4);

87 
	gÿÎ“_tim”
 +ğ
a
[4].
_şocks
;

91 
fšdfunc_¡¬t
() {

92 
S‘upTim”
(5);

93 
S¹Tim”
(5);

97 
fšdfunc_’d
() {

98 
StİTim”
(5);

99 
	gfšdfunc_tim”
 +ğ
a
[5].
_şocks
;

103 
·ylßd_¡¬t
() {

104 
S‘upTim”
(6);

105 
S¹Tim”
(6);

109 
·ylßd_’d
() {

110 
StİTim”
(6);

111 
	g·ylßd_tim”
 +ğ
a
[6].
_şocks
;

115 
»pÜt_tim”
() {

116 
¥_´št
("=== dumpimer ===");

118 
¥_´št
(" Prİ–Ër::gØ- %ld", 
´İ–Ër_tim”
);

127 
S‘upTim”
(
i
) {

128 
	ga
[
i
].
	g_şocks
 = 0;

129 
	ga
[
i
].
	g_¡¬t
 = 0;

130 
	ga
[
i
].
	g_äeq
 = 1000;

131 
Re£tTim”
(
i
);

135 
S¹Tim”
(
i
) {

136 
timev®
 
	gs
;

137 
g‘timeofday
(&
s
, 0);

138 
	ga
[
i
].
	g_¡¬t
 = (
i64
)
s
.
tv_£c
 * 1000*1000 + (i64)s.
tv_u£c
;

142 
StİTim”
(
i
) {

143 
i64
 
	gn
 = 0;

144 
timev®
 
	gs
;

145 
g‘timeofday
(&
s
, 0);

146 
	gn
 = (
i64
)
s
.
tv_£c
 * 1000 *1000 + (i64)s.
tv_u£c
;

147 
	gn
 -ğ
a
[
i
].
_¡¬t
;

148 
	ga
[
i
].
	g_¡¬t
 = 0;

149 
	ga
[
i
].
	g_şocks
 +ğ
n
;

153 
Re£tTim”
(
i
) {

154 
	ga
[
i
].
	g_şocks
 = 0;

158 
G‘Tim”
(
i
) {

159  ()
	ga
[
i
].
	g_şocks
;

163 
PrštTime
(*
msg
, 
i
) {

164 ià(
	gmsg
 !ğ
NULL
)

165 
´štf
("%s: %à£c\n", 
msg
, 
G‘Tim”
(
i
));

167 
´štf
("%à£c\n", 
G‘Tim”
(
i
));

	@SpUtils.h

1 #iâdeà
_SPUTILS_H_


2 
	#_SPUTILS_H_


	)

4 
	~"SpAg’tCommÚ.h
"

6 
Çme¥aû
 
	g¥
 {

9 
S‘upTim”
();

10 
S¹Tim”
();

11 
StİTim”
();

12 
Re£tTim”
();

13 
G‘Tim”
();

14 
PrštTime
(*, );

16 
š¡rum’‹r_¡¬t
();

17 
š¡rum’‹r_’d
();

19 
š¡®l_¡¬t
();

20 
š¡®l_’d
();

22 
´İ–Ër_¡¬t
();

23 
´İ–Ër_’d
();

25 
Ãxt_pošt_¡¬t
();

26 
Ãxt_pošt_’d
();

28 
ÿÎ“_¡¬t
();

29 
ÿÎ“_’d
();

31 
fšdfunc_¡¬t
();

32 
fšdfunc_’d
();

34 
·ylßd_¡¬t
();

35 
·ylßd_’d
();

37 
»pÜt_tim”
();

40 
šlše
 
boŞ
 
is_di¥32
(
d
) {

41 cÚ¡ 
	gmax_št32
 = 2147483646;

42 cÚ¡ 
	gmš_št32
 = -2147483647;

43  ((
	gd
 < 
	gmax_št32
è&& (d >ğ
mš_št32
));

47 
šlše
 
boŞ
 
is_di¥8
(
d
) {

48 cÚ¡ 
	gmax_št8
 = 127;

49 cÚ¡ 
	gmš_št8
 = -128;

50  ((
	gd
 < 
	gmax_št8
è&& (d >ğ
mš_št8
));

	@
1
.
1
/usr/include
15
188
SpAddrSpace.C
SpAgent.C
SpArch-i386.C
SpArch-x86_64.C
SpContext.C
SpEvent.C
SpInstrumenter.C
SpIpcMgr.C
SpParser.C
SpPayload.C
SpPointMaker.h
SpPropeller.C
SpSnippet.C
SpUtils.C
SpUtils.h
